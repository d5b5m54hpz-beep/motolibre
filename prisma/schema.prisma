generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ═══════════════════════════════════════════════════════════════
// AUTH & USERS
// ═══════════════════════════════════════════════════════════════

enum Role {
  ADMIN
  OPERADOR
  CLIENTE
  CONTADOR
  RRHH_MANAGER
  COMERCIAL
  VIEWER
  TALLER_EXTERNO
}

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String
  image            String?
  provider         String    @default("credentials")
  password         String?
  phone            String?
  phoneVerifiedAt  DateTime?
  role             Role      @default(CLIENTE)
  totpSecret       String?
  totpEnabled      Boolean   @default(false)
  activo           Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  profiles         UserProfile[]
  cliente          Cliente?

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ═══════════════════════════════════════════════════════════════
// PERMISOS
// ═══════════════════════════════════════════════════════════════

model PermissionProfile {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  grants      PermissionGrant[]
  users       UserProfile[]

  @@map("permission_profiles")
}

model PermissionGrant {
  id          String  @id @default(cuid())
  profileId   String
  profile     PermissionProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  operationId String

  canView     Boolean @default(false)
  canCreate   Boolean @default(false)
  canExecute  Boolean @default(false)
  canApprove  Boolean @default(false)

  @@unique([profileId, operationId])
  @@index([operationId])
  @@map("permission_grants")
}

model UserProfile {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  profileId String
  profile   PermissionProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([userId, profileId])
  @@map("user_profiles")
}

// ═══════════════════════════════════════════════════════════════
// EVENTOS
// ═══════════════════════════════════════════════════════════════

model BusinessEvent {
  id          String   @id @default(cuid())
  operationId String
  entityType  String
  entityId    String
  payload     Json?
  userId      String?
  status      String   @default("COMPLETED")
  error       String?
  createdAt   DateTime @default(now())

  @@index([operationId])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("business_events")
}

// ═══════════════════════════════════════════════════════════════
// FLOTA — MOTOS
// ═══════════════════════════════════════════════════════════════

enum EstadoMoto {
  EN_DEPOSITO
  EN_PATENTAMIENTO
  DISPONIBLE
  RESERVADA
  ALQUILADA
  EN_SERVICE
  EN_REPARACION
  INMOVILIZADA
  RECUPERACION
  BAJA_TEMP
  BAJA_DEFINITIVA
  TRANSFERIDA
}

enum TipoMoto {
  NAKED
  TOURING
  SPORT
  SCOOTER
  CUSTOM
}

enum EstadoPatentamiento {
  PENDIENTE
  EN_TRAMITE
  COMPLETADO
  RECHAZADO
}

enum EstadoSeguro {
  SIN_SEGURO
  EN_TRAMITE
  ACTIVO
  VENCIDO
  SUSPENDIDO
}

enum EstadoLegalMoto {
  LIMPIO
  INHIBIDA
  SECUESTRADA
  EN_JUICIO
}

enum TipoBaja {
  ROBO
  SINIESTRO
  VENTA
  CHATARRA
  DEVOLUCION_FABRICANTE
}

enum TipoDocumentoMoto {
  TITULO
  CEDULA_VERDE
  CEDULA_AZUL
  POLIZA_SEGURO
  VTV
  FORMULARIO_08
  FORMULARIO_12
  FORMULARIO_13
  FOTO_GENERAL
  FOTO_DANO
  INFORME_MECANICO
  OTRO
}

enum MetodoAmortizacion {
  LINEAL
}

enum FuenteKm {
  MANUAL
  GPS
  SERVICE
  INSPECCION
}

model Moto {
  id              String       @id @default(cuid())

  // ── Identificación ──
  marca           String
  modelo          String
  anio            Int
  patente         String?      @unique
  numMotor        String?      @unique
  numChasis       String?      @unique
  color           String?
  cilindrada      Int?
  tipo            TipoMoto     @default(NAKED)

  // ── Estado operativo ──
  estado          EstadoMoto   @default(EN_DEPOSITO)
  estadoAnterior  EstadoMoto?

  // ── Kilometraje ──
  km              Int          @default(0)
  kmUltimaLectura DateTime?

  // ── Patentamiento ──
  estadoPatentamiento  EstadoPatentamiento @default(PENDIENTE)
  fechaPatentamiento   DateTime?
  tramitePatente       String?

  // ── Seguro ──
  estadoSeguro      EstadoSeguro @default(SIN_SEGURO)
  aseguradora       String?
  numPoliza         String?
  fechaInicioSeguro DateTime?
  fechaFinSeguro    DateTime?

  // ── Legal ──
  estadoLegal      EstadoLegalMoto @default(LIMPIO)

  // ── Financiero / Compra ──
  precioCompra      Decimal?   @db.Decimal(12, 2)
  fechaCompra       DateTime?
  proveedorCompra   String?
  numFacturaCompra  String?
  monedaCompra      String     @default("ARS")
  cotizacionCompra  Decimal?   @db.Decimal(12, 2)

  // ── Alquiler ──
  precioAlquilerMensual  Decimal?  @db.Decimal(12, 2)

  // ── Amortización ──
  metodoAmortizacion  MetodoAmortizacion @default(LINEAL)
  vidaUtilMeses       Int        @default(60)
  valorResidual       Decimal    @default(0) @db.Decimal(12, 2)
  fechaAltaContable   DateTime?

  // ── Ubicación ──
  ubicacion        String?

  // ── Imagen ──
  imagenUrl        String?
  fotos            String[]

  // ── Catálogo Público ──
  destacada        Boolean    @default(false)

  // ── Especificaciones Técnicas ──
  potencia         String?
  tipoMotor        String?
  arranque         String?
  frenos           String?
  capacidadTanque  Decimal?   @db.Decimal(5, 2)
  peso             Decimal?   @db.Decimal(6, 2)

  // ── Notas ──
  notas            String?

  // ── Metadata ──
  creadoPor        String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  // ── Relaciones ──
  documentos       DocumentoMoto[]
  historialEstados HistorialEstadoMoto[]
  lecturasKm       LecturaKm[]
  baja             BajaMoto?
  amortizaciones   Amortizacion[]
  contratos        Contrato[]
  solicitudes      Solicitud[]
  mantenimientos   MantenimientoProgramado[] @relation("MantenimientosMoto")

  @@index([estado])
  @@index([marca, modelo])
  @@index([patente])
  @@index([tipo])
  @@index([destacada])
  @@map("motos")
}

model DocumentoMoto {
  id        String             @id @default(cuid())
  motoId    String
  moto      Moto               @relation(fields: [motoId], references: [id], onDelete: Cascade)
  tipo      TipoDocumentoMoto
  nombre    String
  url       String
  tamano    Int?
  mimeType  String?
  notas     String?
  creadoPor String?
  createdAt DateTime           @default(now())

  @@index([motoId])
  @@map("documentos_moto")
}

model HistorialEstadoMoto {
  id             String     @id @default(cuid())
  motoId         String
  moto           Moto       @relation(fields: [motoId], references: [id], onDelete: Cascade)
  estadoAnterior EstadoMoto
  estadoNuevo    EstadoMoto
  motivo         String?
  userId         String?
  createdAt      DateTime   @default(now())

  @@index([motoId])
  @@index([createdAt])
  @@map("historial_estado_moto")
}

model LecturaKm {
  id        String    @id @default(cuid())
  motoId    String
  moto      Moto      @relation(fields: [motoId], references: [id], onDelete: Cascade)
  km        Int
  fuente    FuenteKm  @default(MANUAL)
  notas     String?
  userId    String?
  createdAt DateTime  @default(now())

  @@index([motoId])
  @@index([createdAt])
  @@map("lecturas_km")
}

model BajaMoto {
  id              String   @id @default(cuid())
  motoId          String   @unique
  moto            Moto     @relation(fields: [motoId], references: [id], onDelete: Cascade)
  tipo            TipoBaja
  fecha           DateTime @default(now())
  motivo          String
  montoRecuperado Decimal? @db.Decimal(12, 2)
  numDenuncia     String?
  userId          String?
  createdAt       DateTime @default(now())

  @@map("bajas_moto")
}

model Amortizacion {
  id          String   @id @default(cuid())
  motoId      String
  moto        Moto     @relation(fields: [motoId], references: [id], onDelete: Cascade)
  periodo     String
  monto       Decimal  @db.Decimal(12, 2)
  acumulado   Decimal  @db.Decimal(12, 2)
  valorLibros Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now())

  @@unique([motoId, periodo])
  @@index([motoId])
  @@index([periodo])
  @@map("amortizaciones")
}

// ═══════════════════════════════════════════════════════════════
// CONFIGURACION EMPRESA
// ═══════════════════════════════════════════════════════════════

enum CondicionIva {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTISTA
  EXENTO
  CONSUMIDOR_FINAL
}

model ConfiguracionEmpresa {
  id                String       @id @default(cuid())
  razonSocial       String       @default("MotoLibre S.A.")
  cuit              String       @default("30-71617222-4")
  direccion         String       @default("Tucumán 141, Piso 4, Of. I, CABA")
  telefono          String       @default("")
  email             String       @default("")
  condicionIva      CondicionIva @default(RESPONSABLE_INSCRIPTO)
  inicioActividades DateTime?
  logo              String?

  // ── Config Operativa ──
  moneda                String   @default("ARS")
  ivaDefault            Int      @default(21)
  diasGraciaVencimiento Int      @default(7)
  diasReservaMaxima     Int      @default(1)
  puntoVenta            Int      @default(1)
  tipoFacturaDefault    String   @default("B")
  emailNotificaciones   String   @default("")

  // ── Costos Mano de Obra ──
  costoHoraMecanico     Float?
  sueldoBrutoMecanico   Float?
  cargasSocialesPct     Float?   @default(0.43)
  horasLaborablesMes    Int?     @default(176)

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@map("configuracion_empresa")
}

// ═══════════════════════════════════════════════════════════════
// CLIENTES
// ═══════════════════════════════════════════════════════════════

enum EstadoCliente {
  PENDIENTE
  EN_REVISION
  APROBADO
  RECHAZADO
  SUSPENDIDO
  BAJA
}

enum TipoDocumentoCliente {
  DNI_FRENTE
  DNI_DORSO
  LICENCIA_CONDUCIR_FRENTE
  LICENCIA_CONDUCIR_DORSO
  COMPROBANTE_DOMICILIO
  RECIBO_SUELDO
  CONSTANCIA_MONOTRIBUTO
  SELFIE
  CONTRATO_FIRMADO
  OTRO
}

enum TipoLicencia {
  A1
  A2
  A3
}

model Cliente {
  id              String         @id @default(cuid())

  // ── Datos personales ──
  nombre          String
  apellido        String
  email           String         @unique
  telefono        String
  telefonoAlt     String?
  dni             String         @unique
  fechaNacimiento DateTime?
  genero          String?
  nacionalidad    String?        @default("Argentina")

  // ── Licencia de conducir ──
  tipoLicencia    TipoLicencia?
  numLicencia     String?
  fechaVencLicencia DateTime?

  // ── Dirección ──
  calle           String?
  numero          String?
  piso            String?
  depto           String?
  localidad       String?
  provincia       String?        @default("CABA")
  codigoPostal    String?

  // ── Fiscal ──
  cuit            String?        @unique
  condicionIva    CondicionIva   @default(CONSUMIDOR_FINAL)

  // ── Trabajo / Delivery ──
  plataformas     String?
  experienciaMeses Int?

  // ── Estado y aprobación ──
  estado          EstadoCliente  @default(PENDIENTE)
  motivoRechazo   String?
  fechaAprobacion DateTime?
  aprobadoPor     String?

  // ── Scoring ──
  score           Int?           @default(0)

  // ── Referencia ──
  comoNosConocio  String?
  referidoPor     String?

  // ── Imagen ──
  fotoUrl         String?

  // ── Notas internas ──
  notas           String?

  // ── Relación con User (si tiene cuenta) ──
  userId          String?        @unique
  user            User?          @relation(fields: [userId], references: [id])

  // ── Metadata ──
  creadoPor       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // ── Relaciones ──
  documentos      DocumentoCliente[]
  puntajes        PuntajeRider[]
  contratos       Contrato[]
  solicitudes     Solicitud[]
  mantenimientos  MantenimientoProgramado[]

  @@index([estado])
  @@index([email])
  @@index([dni])
  @@index([apellido, nombre])
  @@map("clientes")
}

model DocumentoCliente {
  id                String               @id @default(cuid())
  clienteId         String
  cliente           Cliente              @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  tipo              TipoDocumentoCliente
  nombre            String
  url               String
  tamano            Int?
  mimeType          String?
  verificado        Boolean              @default(false)
  verificadoPor     String?
  fechaVerificacion DateTime?
  notas             String?
  createdAt         DateTime             @default(now())

  @@index([clienteId])
  @@map("documentos_cliente")
}

model PuntajeRider {
  id        String   @id @default(cuid())
  clienteId String
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  categoria String
  valor     Int
  motivo    String?
  userId    String?
  createdAt DateTime @default(now())

  @@index([clienteId])
  @@map("puntajes_rider")
}

// ═══════════════════════════════════════════════════════════════
// CONTRATOS
// ═══════════════════════════════════════════════════════════════

enum EstadoContrato {
  BORRADOR
  ACTIVO
  FINALIZADO
  CANCELADO
  FINALIZADO_COMPRA
  VENCIDO
}

enum FrecuenciaPago {
  SEMANAL
  QUINCENAL
  MENSUAL
}

enum EstadoCuota {
  PENDIENTE
  PAGADA
  PARCIAL
  VENCIDA
  CANCELADA
}

model Contrato {
  id              String          @id @default(cuid())

  // ── Partes ──
  clienteId       String
  cliente         Cliente         @relation(fields: [clienteId], references: [id])
  motoId          String
  moto            Moto            @relation(fields: [motoId], references: [id])

  // ── Estado ──
  estado          EstadoContrato  @default(BORRADOR)

  // ── Fechas ──
  fechaInicio      DateTime?
  fechaFin         DateTime?
  fechaFinReal     DateTime?
  fechaActivacion  DateTime?
  fechaCancelacion DateTime?

  // ── Pago ──
  frecuenciaPago   FrecuenciaPago  @default(MENSUAL)
  montoPeriodo     Decimal         @db.Decimal(12, 2)
  deposito         Decimal         @default(0) @db.Decimal(12, 2)
  depositoDevuelto Boolean         @default(false)
  duracionMeses    Int             @default(12)

  // ── Opción a compra ──
  tieneOpcionCompra Boolean        @default(false)
  precioCompra      Decimal?       @db.Decimal(12, 2)
  fechaEjercicio    DateTime?

  // ── Renovación ──
  renovacionAuto     Boolean        @default(false)
  contratoAnteriorId String?
  contratoAnterior   Contrato?      @relation("Renovacion", fields: [contratoAnteriorId], references: [id])
  contratosRenovados Contrato[]     @relation("Renovacion")

  // ── Cancelación ──
  motivoCancelacion String?
  penalidad         Decimal?        @db.Decimal(12, 2)

  // ── Notas ──
  notas             String?

  // ── Metadata ──
  creadoPor         String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // ── Lease-to-own ──
  esLeaseToOwn      Boolean         @default(false)
  transferidaAt     DateTime?

  // ── Relaciones ──
  cuotas            Cuota[]
  solicitud         Solicitud?
  mantenimientos    MantenimientoProgramado[]

  @@index([clienteId])
  @@index([motoId])
  @@index([estado])
  @@index([fechaInicio])
  @@map("contratos")
}

model Cuota {
  id               String      @id @default(cuid())
  contratoId       String
  contrato         Contrato    @relation(fields: [contratoId], references: [id], onDelete: Cascade)

  numero           Int
  monto            Decimal     @db.Decimal(12, 2)
  fechaVencimiento DateTime

  estado           EstadoCuota @default(PENDIENTE)
  fechaPago        DateTime?
  montoPagado      Decimal?    @db.Decimal(12, 2)

  notas            String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@unique([contratoId, numero])
  @@index([contratoId])
  @@index([estado])
  @@index([fechaVencimiento])
  @@map("cuotas")
}

// ═══════════════════════════════════════════════════════════════
// PRICING — TARIFAS DE ALQUILER
// ═══════════════════════════════════════════════════════════════

enum CondicionMoto {
  NUEVA
  USADA
}

enum PlanDuracion {
  MESES_3
  MESES_6
  MESES_9
  MESES_12
  MESES_24
}

model TarifaAlquiler {
  id              String          @id @default(cuid())

  // ── Dimensiones ──
  marca           String
  modelo          String
  condicion       CondicionMoto
  plan            PlanDuracion
  frecuencia      FrecuenciaPago

  // ── Precio final ──
  precio          Decimal         @db.Decimal(12, 2)

  // ── Componentes de costo (mensual, para desglose) ──
  costoAmortizacion  Decimal?     @db.Decimal(12, 2)
  costoMantenimiento Decimal?     @db.Decimal(12, 2)
  costoSeguro        Decimal?     @db.Decimal(12, 2)
  costoPatente       Decimal?     @db.Decimal(12, 2)
  costoOperativo     Decimal?     @db.Decimal(12, 2)
  margenPct          Float?       @default(0.15) // 15%

  // ── Validez ──
  activo          Boolean         @default(true)
  vigenciaDesde   DateTime        @default(now())
  vigenciaHasta   DateTime?

  // ── Relaciones ──
  historial       HistorialTarifa[]

  // ── Metadata ──
  creadoPor       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([marca, modelo, condicion, plan, frecuencia, vigenciaDesde])
  @@index([marca, modelo])
  @@index([condicion, plan, frecuencia])
  @@index([activo])
  @@map("tarifas_alquiler")
}

// ═══════════════════════════════════════════════════════════════
// SOLICITUDES DE ALQUILER
// ═══════════════════════════════════════════════════════════════

enum EstadoSolicitud {
  PAGO_PENDIENTE
  PAGADA
  EN_EVALUACION
  APROBADA
  EN_ESPERA
  ASIGNADA
  ENTREGADA
  RECHAZADA
  CANCELADA
  REEMBOLSADA
}

model Solicitud {
  id                String           @id @default(cuid())

  // ── Cliente ──
  clienteId         String
  cliente           Cliente          @relation(fields: [clienteId], references: [id])

  // ── Qué quiere ──
  marcaDeseada      String
  modeloDeseado     String
  condicionDeseada  CondicionMoto
  plan              PlanDuracion

  // ── Plan público (F4.1) ──
  planAlquilerId    String?
  planAlquiler      PlanAlquiler?    @relation(fields: [planAlquilerId], references: [id])

  // ── Precios ──
  precioSemanal     Decimal          @db.Decimal(12, 2)
  precioMensual     Decimal?         @db.Decimal(12, 2)
  montoPrimerMes    Decimal          @db.Decimal(12, 2)

  // ── Estado ──
  estado            EstadoSolicitud  @default(PAGO_PENDIENTE)

  // ── Pago adelantado ──
  mpPaymentId       String?
  mpPreferenceId    String?
  fechaPago         DateTime?

  // ── Evaluación ──
  evaluadoPor       String?
  fechaEvaluacion   DateTime?
  motivoRechazo     String?

  // ── Asignación ──
  motoAsignadaId    String?
  moto              Moto?            @relation(fields: [motoAsignadaId], references: [id])
  fechaAsignacion   DateTime?

  // ── Entrega ──
  fechaEntrega      DateTime?

  // ── Contrato generado ──
  contratoId        String?          @unique
  contrato          Contrato?        @relation(fields: [contratoId], references: [id])

  // ── Lista de espera ──
  prioridadEspera   Int?

  // ── Notas ──
  notas             String?

  // ── Metadata ──
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([clienteId])
  @@index([estado])
  @@index([marcaDeseada, modeloDeseado])
  @@index([prioridadEspera])
  @@map("solicitudes")
}

// ═══════════════════════════════════════════════════════════════
// MANTENIMIENTOS PROGRAMADOS
// ═══════════════════════════════════════════════════════════════

enum EstadoMantenimiento {
  PROGRAMADO
  NOTIFICADO
  COMPLETADO
  NO_ASISTIO
  CANCELADO
  REPROGRAMADO
}

model MantenimientoProgramado {
  id              String               @id @default(cuid())

  // ── Relaciones ──
  contratoId      String
  contrato        Contrato             @relation(fields: [contratoId], references: [id])
  motoId          String
  moto            Moto                 @relation("MantenimientosMoto", fields: [motoId], references: [id])
  clienteId       String
  cliente         Cliente              @relation(fields: [clienteId], references: [id])

  // ── Programación ──
  numero          Int
  fechaProgramada DateTime
  fechaRealizada  DateTime?

  // ── Estado ──
  estado          EstadoMantenimiento  @default(PROGRAMADO)
  notas           String?
  notasOperador   String?

  // ── Si se reprogramó ──
  fechaOriginal        DateTime?
  motivoReprogramacion String?

  // ── Metadata ──
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@unique([contratoId, numero])
  @@index([contratoId])
  @@index([motoId])
  @@index([clienteId])
  @@index([fechaProgramada])
  @@index([estado])
  @@map("mantenimientos_programados")
}

// ═══════════════════════════════════════════════════════════════
// PAGOS MERCADOPAGO
// ═══════════════════════════════════════════════════════════════

enum EstadoPagoMP {
  PENDIENTE
  APROBADO
  RECHAZADO
  REEMBOLSADO
  EN_PROCESO
  CANCELADO
}

enum TipoPagoMP {
  PRIMER_MES
  CUOTA_RECURRENTE
  CUOTA_INDIVIDUAL
  REFUND
  PEDIDO_REPUESTOS
}

model PagoMercadoPago {
  id                String        @id @default(cuid())

  tipo              TipoPagoMP

  solicitudId       String?
  contratoId        String?
  cuotaId           String?
  ordenVentaId      String?

  mpPaymentId       String?       @unique
  mpPreferenceId    String?
  mpPreapprovalId   String?
  mpStatus          String?
  mpStatusDetail    String?
  mpPaymentMethodId String?
  mpPaymentTypeId   String?

  monto             Decimal       @db.Decimal(12, 2)
  montoNeto         Decimal?      @db.Decimal(12, 2)
  comisionMP        Decimal?      @db.Decimal(12, 2)

  estado            EstadoPagoMP  @default(PENDIENTE)

  fechaPago         DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([solicitudId])
  @@index([contratoId])
  @@index([cuotaId])
  @@index([ordenVentaId])
  @@index([mpPaymentId])
  @@index([estado])
  @@map("pagos_mercadopago")
}

model SuscripcionMP {
  id                String    @id @default(cuid())
  contratoId        String    @unique
  clienteEmail      String
  mpPreapprovalId   String    @unique
  mpStatus          String
  frecuencia        String
  monto             Decimal   @db.Decimal(12, 2)
  fechaInicio       DateTime
  fechaFin          DateTime
  initPoint         String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([contratoId])
  @@index([mpPreapprovalId])
  @@map("suscripciones_mp")
}

// ═══════════════════════════════════════════════════════════════
// FACTURAS
// ═══════════════════════════════════════════════════════════════

enum TipoFactura {
  A    // RI → RI (discrimina IVA)
  B    // RI → CF/Mono/Exento (IVA incluido)
  C    // Monotributista → cualquiera
}

enum EstadoFactura {
  GENERADA      // PDF generado, pendiente de envío
  ENVIADA       // Email enviado al cliente
  ANULADA       // Nota de crédito emitida
}

model Factura {
  id              String         @id @default(cuid())

  // ── Numeración ──
  tipo            TipoFactura
  puntoVenta      String         // "0001"
  numero          Int            // secuencial por tipo+puntoVenta
  numeroCompleto  String         @unique  // "A-0001-00000001"

  // ── Emisor ──
  emisorRazonSocial   String
  emisorCuit          String
  emisorCondicionIva  String
  emisorDomicilio     String

  // ── Receptor ──
  receptorNombre      String
  receptorCuit        String?
  receptorCondicionIva String
  receptorDomicilio   String?

  // ── Montos ──
  montoNeto       Decimal        @db.Decimal(12, 2)
  montoIva        Decimal        @db.Decimal(12, 2)
  montoTotal      Decimal        @db.Decimal(12, 2)

  // ── CAE / AFIP ──
  cae               String?
  caeVencimiento    DateTime?
  afipResultado     String?          // "A" aprobado, "R" rechazado, "PENDIENTE", "STUB"
  afipObservaciones String?
  afipReintentos    Int              @default(0)

  // ── Concepto ──
  concepto        String
  periodoDesde    DateTime?
  periodoHasta    DateTime?

  // ── Relaciones ──
  clienteId       String
  contratoId      String?
  pagoMPId        String?
  cuotaId         String?

  // ── Estado ──
  estado          EstadoFactura  @default(GENERADA)
  fechaEmision    DateTime       @default(now())
  emailEnviado    Boolean        @default(false)
  emailEnviadoAt  DateTime?

  // ── PDF ──
  pdfUrl          String?

  // ── Metadata ──
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@unique([tipo, puntoVenta, numero])
  @@index([clienteId])
  @@index([contratoId])
  @@index([estado])
  @@index([fechaEmision])
  @@map("facturas")
}

// ═══════════════════════════════════════════════════════════════
// CONTABILIDAD — PLAN DE CUENTAS
// ═══════════════════════════════════════════════════════════════

enum TipoCuenta {
  ACTIVO
  PASIVO
  PATRIMONIO
  INGRESO
  EGRESO
}

model CuentaContable {
  id                String          @id @default(cuid())
  codigo            String          @unique    // "1.1.01.001"
  nombre            String                     // "Caja en Pesos"
  tipo              TipoCuenta                 // ACTIVO, PASIVO, etc.
  nivel             Int                        // 1=rubro, 2=subrubro, 3=cuenta, 4=subcuenta
  padreId           String?
  padre             CuentaContable? @relation("CuentaHijos", fields: [padreId], references: [id])
  hijos             CuentaContable[] @relation("CuentaHijos")
  aceptaMovimientos Boolean         @default(false) // true = se pueden cargar asientos
  activa            Boolean         @default(true)
  descripcion       String?

  // ── Relaciones ──
  lineasAsiento     LineaAsiento[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([codigo])
  @@index([tipo])
  @@index([padreId])
  @@index([nivel])
  @@map("cuentas_contables")
}

// ═══════════════════════════════════════════════════════════════
// CONTABILIDAD — ASIENTOS
// ═══════════════════════════════════════════════════════════════

enum TipoAsiento {
  MANUAL            // Creado por el usuario
  VENTA             // Cobro de alquiler
  COMPRA            // Compra de moto u otro activo
  DEPRECIACION      // Amortización mensual
  GASTO             // Gasto operativo
  AJUSTE            // Ajuste contable
  CIERRE            // Asiento de cierre de ejercicio
  CONCILIACION      // Ajuste por diferencia de conciliación bancaria
}

model AsientoContable {
  id              String         @id @default(cuid())
  numero          Int            @unique @default(autoincrement())
  fecha           DateTime
  tipo            TipoAsiento
  descripcion     String
  totalDebe       Decimal        @db.Decimal(14, 2) @default(0)
  totalHaber      Decimal        @db.Decimal(14, 2) @default(0)
  cerrado         Boolean        @default(false) // una vez verificado, no se edita

  // ── Origen ──
  origenTipo      String?        // "Contrato", "PagoMercadoPago", "Factura", etc.
  origenId        String?        // ID de la entidad que generó el asiento
  eventoId        String?        // BusinessEvent que lo disparó

  // ── Período ──
  periodoId       String?
  periodo         PeriodoContable? @relation(fields: [periodoId], references: [id])

  // ── Líneas ──
  lineas          LineaAsiento[]

  // ── Metadata ──
  creadoPor       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([fecha])
  @@index([tipo])
  @@index([periodoId])
  @@index([origenTipo, origenId])
  @@map("asientos_contables")
}

model LineaAsiento {
  id              String          @id @default(cuid())

  asientoId       String
  asiento         AsientoContable @relation(fields: [asientoId], references: [id], onDelete: Cascade)

  cuentaId        String
  cuenta          CuentaContable  @relation(fields: [cuentaId], references: [id])

  debe            Decimal         @db.Decimal(14, 2) @default(0)
  haber           Decimal         @db.Decimal(14, 2) @default(0)
  descripcion     String?

  createdAt       DateTime        @default(now())

  @@index([asientoId])
  @@index([cuentaId])
  @@map("lineas_asiento")
}

// ═══════════════════════════════════════════════════════════════
// CONTABILIDAD — PERÍODOS
// ═══════════════════════════════════════════════════════════════

model PeriodoContable {
  id              String    @id @default(cuid())
  anio            Int
  mes             Int       // 1-12
  nombre          String    // "Enero 2026", "Febrero 2026"
  cerrado         Boolean   @default(false)
  fechaCierre     DateTime?
  cerradoPor      String?

  asientos        AsientoContable[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([anio, mes])
  @@index([cerrado])
  @@map("periodos_contables")
}

// ═══════════════════════════════════════════════════════════════
// GASTOS
// ═══════════════════════════════════════════════════════════════

enum CategoriaGasto {
  COMBUSTIBLE
  SEGUROS
  MANTENIMIENTO
  REPUESTOS
  ADMINISTRATIVO
  ALQUILER_LOCAL
  SERVICIOS
  IMPUESTOS
  BANCARIOS
  PUBLICIDAD
  SUELDOS
  LEGAL
  OTROS
}

enum EstadoGasto {
  PENDIENTE
  APROBADO
  RECHAZADO
  ANULADO
}

model Gasto {
  id              String         @id @default(cuid())
  fecha           DateTime
  monto           Decimal        @db.Decimal(12, 2)
  categoria       CategoriaGasto
  descripcion     String
  comprobante     String?
  estado          EstadoGasto    @default(PENDIENTE)

  medioPago       String         @default("CAJA")

  responsableId   String?
  aprobadoPor     String?
  aprobadoAt      DateTime?

  asientoId       String?

  motoId          String?
  contratoId      String?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([categoria])
  @@index([estado])
  @@index([fecha])
  @@index([motoId])
  @@map("gastos")
}

// ═══════════════════════════════════════════════════════════════
// PRESUPUESTOS MENSUALES
// ═══════════════════════════════════════════════════════════════

model PresupuestoMensual {
  id                 String         @id @default(cuid())
  anio               Int
  mes                Int
  categoria          CategoriaGasto
  montoPresupuestado Decimal        @db.Decimal(12, 2)
  montoEjecutado     Decimal        @db.Decimal(12, 2) @default(0)
  notas              String?

  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@unique([anio, mes, categoria])
  @@index([anio, mes])
  @@map("presupuestos_mensuales")
}

// ═══════════════════════════════════════════════════════════════
// NOTAS DE CRÉDITO
// ═══════════════════════════════════════════════════════════════

enum TipoNotaCredito {
  ANULACION
  DESCUENTO
  DEVOLUCION
}

enum EstadoNotaCredito {
  GENERADA
  ENVIADA
  ANULADA
}

model NotaCredito {
  id              String            @id @default(cuid())

  tipo            TipoNotaCredito
  tipoComprobante String            @default("NC")
  puntoVenta      String
  numero          Int
  numeroCompleto  String            @unique

  facturaId       String
  facturaNumero   String

  receptorNombre  String
  receptorCuit    String?
  receptorCondicionIva String

  montoNeto       Decimal           @db.Decimal(12, 2)
  montoIva        Decimal           @db.Decimal(12, 2)
  montoTotal      Decimal           @db.Decimal(12, 2)

  motivo          String

  estado          EstadoNotaCredito @default(GENERADA)
  fechaEmision    DateTime          @default(now())

  cae               String?
  caeVencimiento    DateTime?
  afipResultado     String?
  afipObservaciones String?
  afipReintentos    Int              @default(0)

  clienteId       String
  asientoId       String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([tipoComprobante, puntoVenta, numero])
  @@index([facturaId])
  @@index([clienteId])
  @@index([estado])
  @@map("notas_credito")
}

// ═══════════════════════════════════════════════════════════════
// FACTURAS DE COMPRA (PROVEEDORES)
// ═══════════════════════════════════════════════════════════════

enum TipoFacturaCompra {
  A
  B
  C
  M
}

enum EstadoFacturaCompra {
  PENDIENTE
  PAGADA
  PARCIAL
  ANULADA
}

model FacturaCompra {
  id              String              @id @default(cuid())

  proveedorNombre String
  proveedorCuit   String
  proveedorCondicionIva String
  proveedorId     String?

  tipo            TipoFacturaCompra
  puntoVenta      String
  numero          String
  numeroCompleto  String

  montoNeto       Decimal             @db.Decimal(12, 2)
  montoIva        Decimal             @db.Decimal(12, 2)
  montoTotal      Decimal             @db.Decimal(12, 2)

  fechaEmision    DateTime
  fechaVencimiento DateTime?

  cae             String?

  concepto        String
  categoria       CategoriaGasto?

  estado          EstadoFacturaCompra @default(PENDIENTE)
  montoPagado     Decimal             @db.Decimal(12, 2) @default(0)

  archivoUrl      String?

  asientoId       String?
  motoId          String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([proveedorCuit])
  @@index([proveedorId])
  @@index([estado])
  @@index([fechaEmision])
  @@index([tipo])
  @@map("facturas_compra")
}

// ═══════════════════════════════════════════════════════════════
// MANTENIMIENTOS — ÓRDENES DE TRABAJO
// ═══════════════════════════════════════════════════════════════

enum EstadoOT {
  SOLICITADA
  APROBADA
  PROGRAMADA
  EN_ESPERA_REPUESTOS
  EN_EJECUCION
  EN_REVISION
  COMPLETADA
  CANCELADA
}

enum TipoOT {
  PREVENTIVO
  CORRECTIVO
  EMERGENCIA
}

enum PrioridadOT {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

enum TipoService {
  SERVICE_5000KM
  SERVICE_10000KM
  SERVICE_15000KM
  SERVICE_20000KM
  SERVICE_GENERAL
  REPARACION
  INSPECCION
  OTRO
}

enum CategoriaTarea {
  MOTOR
  FRENOS
  SUSPENSION
  ELECTRICA
  CARROCERIA
  NEUMATICOS
  TRANSMISION
  LUBRICACION
  INSPECCION
  OTRO
}

enum AccionTarea {
  CHECK
  REPLACE
  CHECK_AND_ADJUST
  ADJUST
}

enum EstadoPlan {
  BORRADOR
  PUBLICADO
  ARCHIVADO
}

enum ResultadoTarea {
  PENDIENTE
  OK
  REQUIERE_ATENCION
  REEMPLAZADO
  NO_APLICA
}

enum TipoItemOT {
  MANO_OBRA
  REPUESTO
  INSUMO
}

model OrdenTrabajo {
  id                  String        @id @default(cuid())

  // ── Identificación ──
  numero              String        @unique  // "OT-2026-00001"
  tipo                TipoOT
  prioridad           PrioridadOT   @default(MEDIA)
  tipoService         TipoService?
  estado              EstadoOT      @default(SOLICITADA)

  // ── Moto ──
  motoId              String
  kmIngreso           Int?
  kmEgreso            Int?

  // ── Cliente/Contrato ──
  contratoId          String?
  clienteId           String?

  // ── Programación ──
  fechaSolicitud      DateTime      @default(now())
  fechaAprobacion     DateTime?
  fechaProgramada     DateTime?
  fechaInicioReal     DateTime?
  fechaFinReal        DateTime?
  fechaCheckIn        DateTime?
  fechaCheckOut       DateTime?

  // ── Taller/Mecánico ──
  tallerNombre        String?
  mecanicoNombre      String?

  // ── Descripción ──
  descripcion         String
  diagnostico         String?
  observaciones       String?
  motivoCancelacion   String?

  // ── Costos ──
  costoManoObra       Decimal?      @db.Decimal(12, 2) @default(0)
  costoRepuestos      Decimal?      @db.Decimal(12, 2) @default(0)
  costoTotal          Decimal?      @db.Decimal(12, 2) @default(0)

  // ── Origen ──
  mantenimientoProgramadoId String?
  planMantenimientoId String?
  planMantenimiento   PlanMantenimiento? @relation(fields: [planMantenimientoId], references: [id])
  solicitadoPor       String?

  // ── Taller/Mecánico FK ──
  tallerId            String?
  mecanicoId          String?

  // ── Contabilidad ──
  asientoId           String?

  // ── Relaciones ──
  tareas              TareaOrdenTrabajo[]
  repuestos           RepuestoOrdenTrabajo[]
  items               ItemOT[]
  fotos               FotoInspeccion[]
  historial           HistorialOT[]

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@index([estado])
  @@index([motoId])
  @@index([tipo])
  @@index([fechaProgramada])
  @@index([mantenimientoProgramadoId])
  @@map("ordenes_trabajo")
}

model TareaOrdenTrabajo {
  id                String          @id @default(cuid())
  ordenTrabajoId    String
  ordenTrabajo      OrdenTrabajo    @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  categoria         CategoriaTarea
  descripcion       String
  resultado         ResultadoTarea  @default(PENDIENTE)
  observaciones     String?
  orden             Int             @default(0)

  itemServiceId     String?
  itemService       ItemService?    @relation(fields: [itemServiceId], references: [id])
  tiempoEstimado    Int?            // minutos, copiado desde ItemService

  createdAt         DateTime        @default(now())

  @@index([ordenTrabajoId])
  @@map("tareas_orden_trabajo")
}

model RepuestoOrdenTrabajo {
  id                String          @id @default(cuid())
  ordenTrabajoId    String
  ordenTrabajo      OrdenTrabajo    @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  nombre            String
  cantidad          Int
  precioUnitario    Decimal         @db.Decimal(12, 2)
  subtotal          Decimal         @db.Decimal(12, 2)
  repuestoId        String?

  createdAt         DateTime        @default(now())

  @@index([ordenTrabajoId])
  @@map("repuestos_orden_trabajo")
}

model ItemOT {
  id                String          @id @default(cuid())
  ordenTrabajoId    String
  ordenTrabajo      OrdenTrabajo    @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  tipo              TipoItemOT
  descripcion       String
  cantidad          Int             @default(1)
  precioUnitario    Decimal         @db.Decimal(12, 2)
  subtotal          Decimal         @db.Decimal(12, 2)

  // ── Mano de obra ──
  mecanicoId        String?
  tiempoMinutos     Int?

  // ── Repuesto / Insumo ──
  repuestoId        String?
  codigoOEM         String?

  createdAt         DateTime        @default(now())

  @@index([ordenTrabajoId])
  @@index([tipo])
  @@map("items_ot")
}

model FotoInspeccion {
  id                String          @id @default(cuid())
  ordenTrabajoId    String
  ordenTrabajo      OrdenTrabajo    @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  url               String
  tipo              String          // "CHECK_IN", "CHECK_OUT", "DURANTE", "REPUESTO"
  descripcion       String?

  createdAt         DateTime        @default(now())

  @@index([ordenTrabajoId])
  @@map("fotos_inspeccion")
}

model HistorialOT {
  id                String          @id @default(cuid())
  ordenTrabajoId    String
  ordenTrabajo      OrdenTrabajo    @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  estadoAnterior    EstadoOT
  estadoNuevo       EstadoOT
  descripcion       String?
  userId            String?

  createdAt         DateTime        @default(now())

  @@index([ordenTrabajoId])
  @@map("historial_ot")
}

// ═══════════════════════════════════════════════════════════════
// PLANES DE MANTENIMIENTO (TEMPLATES)
// ═══════════════════════════════════════════════════════════════

model ItemService {
  id              String          @id @default(cuid())
  nombre          String
  categoria       CategoriaTarea
  accion          AccionTarea     @default(CHECK)
  descripcion     String?
  tiempoEstimado  Int?            // minutos
  activo          Boolean         @default(true)

  // ── Relaciones ──
  tareasQueLoUsan    TareaPlan[]
  tareasOT           TareaOrdenTrabajo[]
  repuestosSugeridos ItemServiceRepuesto[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([categoria])
  @@index([activo])
  @@map("items_service")
}

model ItemServiceRepuesto {
  id              String      @id @default(cuid())

  itemServiceId   String
  itemService     ItemService @relation(fields: [itemServiceId], references: [id], onDelete: Cascade)

  repuestoId      String
  repuesto        Repuesto    @relation(fields: [repuestoId], references: [id], onDelete: Cascade)

  cantidadDefault Int         @default(1)
  obligatorio     Boolean     @default(false)
  notas           String?
  origenIA        Boolean     @default(false)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([itemServiceId, repuestoId])
  @@index([itemServiceId])
  @@index([repuestoId])
  @@map("item_service_repuestos")
}

model PlanMantenimiento {
  id                String          @id @default(cuid())
  nombre            String
  tipoService       TipoService
  descripcion       String?

  // ── Vehículo vinculado ──
  marcaMoto         String?
  modeloMoto        String?

  // ── Intervalos ──
  kmIntervalo       Int?
  diasIntervalo     Int?

  // ── Garantía ──
  garantiaMeses     Int?
  garantiaKm        Int?

  // ── Estado ──
  estado            EstadoPlan      @default(BORRADOR)
  activo            Boolean         @default(true)

  // ── Audit ──
  creadoPor         String?
  actualizadoPor    String?

  // ── Relaciones ──
  tareas            TareaPlan[]
  repuestos         RepuestoTareaPlan[]
  ordenesGeneradas  OrdenTrabajo[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([estado])
  @@index([marcaMoto, modeloMoto])
  @@map("planes_mantenimiento")
}

model TareaPlan {
  id                String          @id @default(cuid())
  planId            String
  plan              PlanMantenimiento @relation(fields: [planId], references: [id], onDelete: Cascade)

  categoria         CategoriaTarea
  descripcion       String
  accion            AccionTarea     @default(CHECK)
  orden             Int             @default(0)
  tiempoEstimado    Int?            // minutos

  // ── Catálogo ──
  itemServiceId     String?
  itemService       ItemService?    @relation(fields: [itemServiceId], references: [id])

  createdAt         DateTime        @default(now())

  @@index([planId])
  @@map("tareas_plan")
}

model RepuestoTareaPlan {
  id                String          @id @default(cuid())
  planId            String
  plan              PlanMantenimiento @relation(fields: [planId], references: [id], onDelete: Cascade)

  nombre            String
  codigoOEM         String?
  cantidad          Int             @default(1)
  unidad            String?         // "litros", "unidad", etc.
  capacidad         String?         // "1.1L ± 0.1L"
  precioUnitario    Float?

  // ── Vinculación inventario ──
  repuestoId            String?
  repuestoInventario    Repuesto?   @relation(fields: [repuestoId], references: [id])

  createdAt         DateTime        @default(now())

  @@index([planId])
  @@map("repuestos_tarea_plan")
}

// ═══════════════════════════════════════════════════════════════
// TALLERES Y MECÁNICOS
// ═══════════════════════════════════════════════════════════════

enum TipoTaller {
  INTERNO
  EXTERNO
}

enum EstadoSolicitudTaller {
  BORRADOR
  RECIBIDA
  INCOMPLETA
  EN_EVALUACION
  APROBADA
  RECHAZADA
  EN_ESPERA
  CONVENIO_ENVIADO
  CONVENIO_FIRMADO
  ONBOARDING
  ACTIVO
}

enum CategoriaEvaluacion {
  INFRAESTRUCTURA
  EQUIPAMIENTO
  PERSONAL
  DOCUMENTACION
  UBICACION
  EXPERIENCIA
  REFERENCIAS
}

model Taller {
  id              String      @id @default(cuid())
  nombre          String
  tipo            TipoTaller
  direccion       String?
  telefono        String?
  email           String?
  contacto        String?
  especialidades  String[]
  activo          Boolean     @default(true)
  notas           String?
  tarifaHora      Float?      // $/hora para cálculo de costos

  mecanicos       Mecanico[]

  // Red de Talleres
  solicitud         SolicitudTaller?
  codigoRed         String?     @unique  // "ML-CABA-001"
  userId            String?     @unique  // User del portal taller
  capacidadOTMes    Int?
  horariosAtencion  String?
  latitud           Float?
  longitud          Float?
  scoreCalidad      Float?
  otCompletadas     Int         @default(0)
  tiempoPromedioOT  Int?        // minutos
  asignaciones      AsignacionOT[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([tipo])
  @@index([activo])
  @@map("talleres")
}

model Mecanico {
  id              String      @id @default(cuid())
  nombre          String
  apellido        String
  telefono        String?
  email           String?
  especialidad    String?
  tarifaHora      Float?      // $/hora para mecánicos externos
  activo          Boolean     @default(true)

  tallerId        String
  taller          Taller      @relation(fields: [tallerId], references: [id])

  empleadoId      String?     @unique
  empleado        Empleado?   @relation(fields: [empleadoId], references: [id])

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([tallerId])
  @@index([activo])
  @@map("mecanicos")
}

// ═══════════════════════════════════════════════════════════════
// HISTORIAL DE TARIFAS
// ═══════════════════════════════════════════════════════════════

enum TipoAjuste {
  INCREMENTO
  DECREMENTO
  NUEVO
}

model HistorialTarifa {
  id                  String          @id @default(cuid())
  tarifaAlquilerId    String
  tarifaAlquiler      TarifaAlquiler  @relation(fields: [tarifaAlquilerId], references: [id], onDelete: Cascade)

  campo               String          // ej: "precio", "costoSeguro"
  valorAnterior       String?
  valorNuevo          String
  tipoAjuste          TipoAjuste
  motivo              String?
  userId              String?

  createdAt           DateTime        @default(now())

  @@index([tarifaAlquilerId])
  @@map("historial_tarifas")
}

// ═══════════════════════════════════════════════════════════════
// PROVEEDORES
// ═══════════════════════════════════════════════════════════════

enum TipoProveedor {
  NACIONAL
  INTERNACIONAL
}

model Proveedor {
  id              String         @id @default(cuid())
  nombre          String
  cuit            String?
  direccion       String?
  ciudad          String?
  provincia       String?
  pais            String         @default("Argentina")
  telefono        String?
  email           String?
  contacto        String?
  tipoProveedor   TipoProveedor  @default(NACIONAL)
  condicionIva    String?
  categorias      String[]
  notas           String?
  activo          Boolean        @default(true)

  // ── Datos bancarios ──
  cbu             String?
  alias           String?
  banco           String?

  // ── Relaciones ──
  ordenesCompra   OrdenCompra[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([tipoProveedor])
  @@index([activo])
  @@map("proveedores")
}

// ═══════════════════════════════════════════════════════════════
// ÓRDENES DE COMPRA
// ═══════════════════════════════════════════════════════════════

enum EstadoOrdenCompra {
  BORRADOR
  ENVIADA
  CONFIRMADA
  RECIBIDA
  CANCELADA
}

model OrdenCompra {
  id              String             @id @default(cuid())
  numero          String             @unique

  // ── Proveedor ──
  proveedorId     String
  proveedor       Proveedor          @relation(fields: [proveedorId], references: [id])

  // ── Estado ──
  estado          EstadoOrdenCompra  @default(BORRADOR)

  // ── Fechas ──
  fechaEmision    DateTime           @default(now())
  fechaEntregaEstimada DateTime?
  fechaRecepcion  DateTime?

  // ── Montos ──
  montoSubtotal   Decimal            @db.Decimal(12, 2) @default(0)
  montoIva        Decimal            @db.Decimal(12, 2) @default(0)
  montoTotal      Decimal            @db.Decimal(12, 2) @default(0)
  moneda          String             @default("ARS")

  // ── Metadata ──
  observaciones   String?
  motivoCancelacion String?
  aprobadoPor     String?
  creadoPor       String?

  // ── Items ──
  items           ItemOrdenCompra[]

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([proveedorId])
  @@index([estado])
  @@index([fechaEmision])
  @@map("ordenes_compra")
}

model ItemOrdenCompra {
  id              String        @id @default(cuid())
  ordenCompraId   String
  ordenCompra     OrdenCompra   @relation(fields: [ordenCompraId], references: [id], onDelete: Cascade)

  // ── Producto ──
  descripcion     String
  codigo          String?
  repuestoId      String?

  // ── Cantidades ──
  cantidad        Int
  cantidadRecibida Int          @default(0)

  // ── Precios ──
  precioUnitario  Decimal       @db.Decimal(12, 2)
  subtotal        Decimal       @db.Decimal(12, 2)

  createdAt       DateTime      @default(now())

  @@index([ordenCompraId])
  @@map("items_orden_compra")
}

// ═══════════════════════════════════════════════════════════════
// INVENTARIO DE REPUESTOS
// ═══════════════════════════════════════════════════════════════

enum CategoriaRepuesto {
  MOTOR
  FRENOS
  SUSPENSION
  ELECTRICA
  TRANSMISION
  CARROCERIA
  NEUMATICOS
  LUBRICANTES
  FILTROS
  TORNILLERIA
  ACCESORIOS
  OTRO
}

enum TipoMovimientoStock {
  INGRESO
  EGRESO
  AJUSTE_POSITIVO
  AJUSTE_NEGATIVO
  TRANSFERENCIA
  DEVOLUCION
}

model Repuesto {
  id                String            @id @default(cuid())

  // ── Identificación ──
  codigo            String            @unique
  nombre            String
  descripcion       String?
  categoria         CategoriaRepuesto
  marca             String?
  modeloCompatible  String[]

  // ── Stock ──
  stock             Int               @default(0)
  stockMinimo       Int               @default(5)
  stockMaximo       Int?
  unidad            String            @default("unidad")

  // ── Precios ──
  precioCompra      Decimal           @db.Decimal(12, 2) @default(0)
  precioVenta       Decimal?          @db.Decimal(12, 2)
  moneda            String            @default("ARS")

  // ── Importación ──
  precioFOB         Decimal?          @db.Decimal(12, 2)
  costoNacionalizado Decimal?         @db.Decimal(12, 2)

  // ── Proveedor principal ──
  proveedorId       String?
  proveedorCodigo   String?

  // ── Ubicación ──
  ubicacionId       String?
  ubicacion         UbicacionDeposito? @relation(fields: [ubicacionId], references: [id])

  // ── Estado ──
  activo            Boolean           @default(true)

  // ── Relaciones ──
  movimientos       MovimientoStock[]
  historialCostos   HistorialCostoRepuesto[]
  itemsVenta        ItemVentaRepuesto[]
  planesQueLoUsan   RepuestoTareaPlan[]
  tareasAsociadas   ItemServiceRepuesto[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([codigo])
  @@index([categoria])
  @@index([stock])
  @@index([proveedorId])
  @@index([activo])
  @@map("repuestos")
}

model MovimientoStock {
  id              String              @id @default(cuid())

  repuestoId      String
  repuesto        Repuesto            @relation(fields: [repuestoId], references: [id])

  tipo            TipoMovimientoStock
  cantidad        Int
  stockAnterior   Int
  stockPosterior  Int

  // ── Referencia ──
  referenciaTipo  String?
  referenciaId    String?

  // ── Detalle ──
  descripcion     String?
  costoUnitario   Decimal?            @db.Decimal(12, 2)
  userId          String?

  createdAt       DateTime            @default(now())

  @@index([repuestoId])
  @@index([tipo])
  @@index([createdAt])
  @@map("movimientos_stock")
}

model UbicacionDeposito {
  id              String      @id @default(cuid())
  codigo          String      @unique
  nombre          String
  sector          String?
  nivel           String?
  descripcion     String?
  activa          Boolean     @default(true)

  repuestos       Repuesto[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("ubicaciones_deposito")
}

model HistorialCostoRepuesto {
  id              String      @id @default(cuid())
  repuestoId      String
  repuesto        Repuesto    @relation(fields: [repuestoId], references: [id])

  precioAnterior  Decimal     @db.Decimal(12, 2)
  precioNuevo     Decimal     @db.Decimal(12, 2)
  motivo          String?

  createdAt       DateTime    @default(now())

  @@index([repuestoId])
  @@map("historial_costo_repuesto")
}

// ═══════════════════════════════════════════════════════════════
// IMPORTACIONES
// ═══════════════════════════════════════════════════════════════

enum EstadoEmbarque {
  BORRADOR
  EN_TRANSITO
  EN_PUERTO
  EN_ADUANA
  DESPACHADO_PARCIAL
  DESPACHADO
  COSTOS_FINALIZADOS
  EN_RECEPCION
  ALMACENADO
  CANCELADO
}

model EmbarqueImportacion {
  id                    String          @id @default(cuid())
  numero                String          @unique
  estado                EstadoEmbarque  @default(BORRADOR)

  proveedorId           String
  proveedorNombre       String

  puertoOrigen          String?
  puertoDestino         String          @default("Buenos Aires")
  naviera               String?
  numeroContenedor      String?
  numeroBL              String?
  tipoTransporte        String          @default("MARITIMO")

  fechaEmbarque         DateTime?
  fechaEstimadaArribo   DateTime?
  fechaArriboPuerto     DateTime?
  fechaIngresoAduana    DateTime?
  fechaDespacho         DateTime?
  fechaRecepcion        DateTime?

  monedaFOB             String          @default("USD")
  totalFOB              Decimal         @db.Decimal(14, 2) @default(0)
  tipoCambio            Decimal?        @db.Decimal(10, 4)

  costoFlete            Decimal?        @db.Decimal(14, 2) @default(0)
  costoSeguro           Decimal?        @db.Decimal(14, 2) @default(0)
  totalCIF              Decimal?        @db.Decimal(14, 2) @default(0)

  derechosImportacion   Decimal?        @db.Decimal(14, 2) @default(0)
  tasaEstadistica       Decimal?        @db.Decimal(14, 2) @default(0)
  ivaImportacion        Decimal?        @db.Decimal(14, 2) @default(0)
  ivaAdicional          Decimal?        @db.Decimal(14, 2) @default(0)
  ingresosBrutos        Decimal?        @db.Decimal(14, 2) @default(0)
  gastosDespacho        Decimal?        @db.Decimal(14, 2) @default(0)

  totalNacionalizado    Decimal?        @db.Decimal(14, 2) @default(0)

  observaciones         String?
  creadoPor             String?

  items                 ItemEmbarque[]
  despachos             DespachoAduanero[]
  costosAsignados       AsignacionCostoImportacion[]

  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([estado])
  @@index([proveedorId])
  @@index([fechaEmbarque])
  @@map("embarques_importacion")
}

model ItemEmbarque {
  id                      String                @id @default(cuid())
  embarqueId              String
  embarque                EmbarqueImportacion   @relation(fields: [embarqueId], references: [id], onDelete: Cascade)

  descripcion             String
  codigoProveedor         String?
  repuestoId              String?
  esMoto                  Boolean               @default(false)

  cantidad                Int
  cantidadRecibida        Int                   @default(0)

  precioFOBUnitario       Decimal               @db.Decimal(12, 2)
  subtotalFOB             Decimal               @db.Decimal(14, 2)

  costoNacionalizadoUnit  Decimal?              @db.Decimal(12, 2)
  costoNacionalizadoTotal Decimal?              @db.Decimal(14, 2)

  posicionArancelaria     String?
  alicuotaDerechos        Decimal?              @db.Decimal(5, 2)

  createdAt               DateTime              @default(now())

  @@index([embarqueId])
  @@map("items_embarque")
}

model DespachoAduanero {
  id                  String                @id @default(cuid())
  embarqueId          String
  embarque            EmbarqueImportacion   @relation(fields: [embarqueId], references: [id], onDelete: Cascade)

  numeroDespacho      String?
  fechaDespacho       DateTime
  despachante         String?

  baseImponible       Decimal               @db.Decimal(14, 2)
  derechosImportacion Decimal               @db.Decimal(14, 2)
  tasaEstadistica     Decimal               @db.Decimal(14, 2)
  ivaImportacion      Decimal               @db.Decimal(14, 2)
  ivaAdicional        Decimal               @db.Decimal(14, 2)
  ingresosBrutos      Decimal               @db.Decimal(14, 2) @default(0)
  gastosVarios        Decimal               @db.Decimal(14, 2) @default(0)
  totalDespacho       Decimal               @db.Decimal(14, 2)

  observaciones       String?

  createdAt           DateTime              @default(now())

  @@index([embarqueId])
  @@map("despachos_aduaneros")
}

model AsignacionCostoImportacion {
  id                  String                @id @default(cuid())
  embarqueId          String
  embarque            EmbarqueImportacion   @relation(fields: [embarqueId], references: [id], onDelete: Cascade)

  itemEmbarqueId      String
  porcentajeFOB       Decimal               @db.Decimal(8, 4)
  costoAsignado       Decimal               @db.Decimal(14, 2)

  createdAt           DateTime              @default(now())

  @@index([embarqueId])
  @@index([itemEmbarqueId])
  @@map("asignaciones_costo_importacion")
}

model PortalProveedorToken {
  id                  String                @id @default(cuid())
  token               String                @unique @default(cuid())
  embarqueId          String
  proveedorId         String
  activo              Boolean               @default(true)
  expiraAt            DateTime

  createdAt           DateTime              @default(now())

  @@index([token])
  @@index([embarqueId])
  @@map("portal_proveedor_tokens")
}

// ═══════════════════════════════════════════════════════════════
// PRICING DE ALQUILER (F4.1)
// ═══════════════════════════════════════════════════════════════

model PlanAlquiler {
  id                  String                 @id @default(cuid())
  nombre              String
  codigo              String                 @unique
  descripcion         String?

  frecuencia          String                 // "SEMANAL", "MENSUAL"
  duracionMeses       Int?
  cuotasTotal         Int?
  descuentoPorcentaje Decimal?               @db.Decimal(5, 2)
  incluyeTransferencia Boolean              @default(false)

  activo              Boolean                @default(true)
  orden               Int                    @default(0)

  precios             PrecioModeloAlquiler[]
  solicitudes         Solicitud[]

  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  @@index([activo])
  @@map("planes_alquiler")
}

model PrecioModeloAlquiler {
  id              String       @id @default(cuid())

  planId          String
  plan            PlanAlquiler @relation(fields: [planId], references: [id], onDelete: Cascade)

  modeloMoto      String
  condicion       String       @default("USADA")

  precioBase      Decimal      @db.Decimal(12, 2)
  precioFinal     Decimal      @db.Decimal(12, 2)
  moneda          String       @default("ARS")

  vigenciaDesde   DateTime     @default(now())
  vigenciaHasta   DateTime?
  activo          Boolean      @default(true)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([planId, modeloMoto, condicion, activo])
  @@index([modeloMoto])
  @@index([activo])
  @@map("precios_modelo_alquiler")
}

model CostoOperativoConfig {
  id            String   @id @default(cuid())
  concepto      String   @unique
  montoMensual  Decimal  @db.Decimal(12, 2)
  descripcion   String?
  activo        Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("costos_operativos_config")
}

model HistorialPrecioAlquiler {
  id              String   @id @default(cuid())
  precioModeloId  String?
  planId          String?
  modeloMoto      String
  precioAnterior  Decimal  @db.Decimal(12, 2)
  precioNuevo     Decimal  @db.Decimal(12, 2)
  motivo          String?
  userId          String?

  createdAt       DateTime @default(now())

  @@index([modeloMoto])
  @@map("historial_precio_alquiler")
}

model TipoCambioCache {
  id        String   @id @default(cuid())
  moneda    String   @unique
  compra    Decimal  @db.Decimal(12, 4)
  venta     Decimal  @db.Decimal(12, 4)
  fecha     DateTime
  fuente    String   @default("dolarapi.com")

  updatedAt DateTime @updatedAt

  @@map("tipo_cambio_cache")
}

// ═══════════════════════════════════════════════════════════════
// PRICING DE REPUESTOS (F4.2)
// ═══════════════════════════════════════════════════════════════

enum TipoListaPrecio {
  RETAIL
  MAYORISTA
  TALLER
  PROMO
}

model ListaPrecio {
  id            String          @id @default(cuid())
  nombre        String
  tipo          TipoListaPrecio
  descripcion   String?
  activa        Boolean         @default(true)
  vigenciaDesde DateTime        @default(now())
  vigenciaHasta DateTime?
  prioridad     Int             @default(0)

  items         ItemListaPrecio[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([tipo])
  @@index([activa])
  @@map("listas_precio")
}

model ItemListaPrecio {
  id             String      @id @default(cuid())
  listaId        String
  lista          ListaPrecio @relation(fields: [listaId], references: [id], onDelete: Cascade)
  repuestoId     String
  precioUnitario Decimal     @db.Decimal(12, 2)

  createdAt      DateTime    @default(now())

  @@unique([listaId, repuestoId])
  @@index([repuestoId])
  @@map("items_lista_precio")
}

model ReglaMarkup {
  id          String            @id @default(cuid())
  categoria   CategoriaRepuesto @unique
  porcentaje  Decimal           @db.Decimal(5, 2)
  descripcion String?
  activa      Boolean           @default(true)

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@map("reglas_markup")
}

model GrupoCliente {
  id          String                @id @default(cuid())
  nombre      String
  descripcion String?
  descuento   Decimal               @db.Decimal(5, 2)
  activo      Boolean               @default(true)

  miembros    MiembroGrupoCliente[]

  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@map("grupos_cliente")
}

model MiembroGrupoCliente {
  id        String       @id @default(cuid())
  grupoId   String
  grupo     GrupoCliente @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  clienteId String

  createdAt DateTime     @default(now())

  @@unique([grupoId, clienteId])
  @@index([clienteId])
  @@map("miembros_grupo_cliente")
}

model LoteCambioPrecio {
  id                 String   @id @default(cuid())
  nombre             String
  tipo               String   // "PORCENTAJE", "MONTO_FIJO"
  valor              Decimal  @db.Decimal(12, 2)
  categorias         String[]
  proveedorId        String?
  estado             String   @default("PENDIENTE")
  fechaAplicacion    DateTime?
  fechaReversion     DateTime?
  repuestosAfectados Int      @default(0)
  userId             String?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("lotes_cambio_precio")
}

// ═══════════════════════════════════════════════════════════════
// DETECCIÓN DE ANOMALÍAS
// ═══════════════════════════════════════════════════════════════

enum TipoAnomalia {
  GASTO_INUSUAL
  PAGO_DUPLICADO
  FACTURA_SIN_PAGO
  MARGEN_BAJO
  STOCK_CRITICO
  DESVIO_PRESUPUESTO
  FLUJO_CAJA_NEGATIVO
  VENCIMIENTO_PROXIMO
  PATRON_SOSPECHOSO
}

enum SeveridadAnomalia {
  BAJA
  MEDIA
  ALTA
  CRITICA
}

enum EstadoAnomalia {
  NUEVA
  EN_REVISION
  RESUELTA
  DESCARTADA
}

model Anomalia {
  id                String              @id @default(cuid())

  tipo              TipoAnomalia
  severidad         SeveridadAnomalia
  estado            EstadoAnomalia      @default(NUEVA)

  // —— Entidad afectada ——
  entidadTipo       String              // "Gasto", "Pago", "Factura", "Moto", "Repuesto", "Presupuesto"
  entidadId         String              // ID de la entidad
  entidadLabel      String?             // Descripción legible: "Gasto #123 - Combustible"

  // —— Detección ——
  titulo            String              // "Gasto inusual detectado: $450.000 en Combustible"
  descripcion       String              // Explicación detallada
  valorDetectado    Decimal?            @db.Decimal(14, 2)
  valorEsperado     Decimal?            @db.Decimal(14, 2)

  // —— Resolución ——
  resueltoPor       String?
  resolucion        String?
  fechaResolucion   DateTime?

  // —— Metadata ——
  algoritmo         String
  datosExtra        String?             // JSON con datos adicionales del algoritmo

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([tipo])
  @@index([estado])
  @@index([severidad])
  @@index([entidadTipo, entidadId])
  @@index([createdAt])
  @@map("anomalias")
}

model AnalisisFinanciero {
  id                  String      @id @default(cuid())

  tipo                String      // "ANOMALIAS_BATCH", "SALUD_FINANCIERA"
  fechaEjecucion      DateTime    @default(now())
  duracionMs          Int?

  anomaliasDetectadas Int         @default(0)
  metricas            String?     // JSON con métricas del análisis

  ejecutadoPor        String?     // userId o "system"

  createdAt           DateTime    @default(now())

  @@index([tipo])
  @@map("analisis_financieros")
}

// ═══════════════════════════════════════════════════════════════
// RRHH
// ═══════════════════════════════════════════════════════════════

enum Departamento {
  ADMINISTRACION
  OPERACIONES
  TALLER
  COMERCIAL
  GERENCIA
}

enum EstadoEmpleado {
  ACTIVO
  LICENCIA
  SUSPENDIDO
  DESVINCULADO
}

enum SexoEmpleado {
  MASCULINO
  FEMENINO
  OTRO
}

enum EstadoCivil {
  SOLTERO
  CASADO
  DIVORCIADO
  VIUDO
  UNION_CONVIVENCIAL
}

enum JornadaLaboral {
  COMPLETA
  MEDIA
  REDUCIDA
}

enum TipoAusencia {
  VACACIONES
  ENFERMEDAD
  INJUSTIFICADA
  LICENCIA_ESPECIAL
  MATERNIDAD
  PATERNIDAD
  ESTUDIO
  FALLECIMIENTO_FAMILIAR
}

enum EstadoAusencia {
  SOLICITADA
  APROBADA
  RECHAZADA
  CANCELADA
}

enum TipoRecibo {
  MENSUAL
  AGUINALDO
  VACACIONES
  LIQUIDACION_FINAL
}

enum EstadoRecibo {
  BORRADOR
  LIQUIDADO
  PAGADO
  ANULADO
}

enum TipoDocumentoEmpleado {
  DNI
  CUIL
  CONTRATO_LABORAL
  ALTA_AFIP
  ART
  OBRA_SOCIAL
  CERTIFICADO_SALUD
  OTRO
}

model Empleado {
  id                 String          @id @default(cuid())

  // — Datos Personales —
  nombre             String
  apellido           String
  dni                String          @unique
  cuil               String?
  sexo               SexoEmpleado?
  estadoCivil        EstadoCivil?
  fechaNacimiento    DateTime?
  nacionalidad       String?         @default("Argentina")
  direccion          String?
  telefono           String?
  email              String?
  contactoEmergencia String?

  // — Datos Laborales —
  legajo             String          @unique
  departamento       Departamento
  cargo              String
  estado             EstadoEmpleado  @default(ACTIVO)
  fechaIngreso       DateTime
  fechaEgreso        DateTime?
  jornada            JornadaLaboral  @default(COMPLETA)

  // — Remuneración —
  sueldoBasico       Decimal         @db.Decimal(12, 2)
  categoriaCCT       String?

  // — Datos Bancarios —
  cbu                String?
  banco              String?
  tipoCuenta         String?

  // — ART + Obra Social —
  artNombre          String?
  artNumero          String?
  obraSocialNombre   String?
  obraSocialNumero   String?

  // — Vínculo con usuario del sistema —
  userId             String?         @unique

  // — Relaciones —
  ausencias          Ausencia[]
  recibos            ReciboSueldo[]
  documentos         DocumentoEmpleado[]
  mecanico           Mecanico?

  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@index([departamento])
  @@index([estado])
  @@map("empleados")
}

model Ausencia {
  id              String         @id @default(cuid())

  empleadoId      String
  empleado        Empleado       @relation(fields: [empleadoId], references: [id], onDelete: Cascade)

  tipo            TipoAusencia
  estado          EstadoAusencia @default(SOLICITADA)

  fechaDesde      DateTime
  fechaHasta      DateTime
  diasHabiles     Int

  motivo          String?
  observaciones   String?

  aprobadoPor     String?
  fechaAprobacion DateTime?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([empleadoId])
  @@index([estado])
  @@index([tipo])
  @@map("ausencias")
}

model ReciboSueldo {
  id                    String       @id @default(cuid())
  numero                String       @unique

  empleadoId            String
  empleado              Empleado     @relation(fields: [empleadoId], references: [id])

  tipo                  TipoRecibo
  estado                EstadoRecibo @default(BORRADOR)
  periodo               String

  // — Haberes —
  sueldoBasico          Decimal      @db.Decimal(12, 2)
  presentismo           Decimal      @db.Decimal(12, 2) @default(0)
  antiguedad            Decimal      @db.Decimal(12, 2) @default(0)
  horasExtra            Decimal      @db.Decimal(12, 2) @default(0)
  otrosHaberes          Decimal      @db.Decimal(12, 2) @default(0)
  totalHaberes          Decimal      @db.Decimal(12, 2)

  // — Deducciones —
  jubilacion            Decimal      @db.Decimal(12, 2)
  obraSocial            Decimal      @db.Decimal(12, 2)
  ley19032              Decimal      @db.Decimal(12, 2)
  sindicato             Decimal      @db.Decimal(12, 2) @default(0)
  impuestoGanancias     Decimal      @db.Decimal(12, 2) @default(0)
  otrasDeduccion        Decimal      @db.Decimal(12, 2) @default(0)
  totalDeducciones      Decimal      @db.Decimal(12, 2)

  // — Neto —
  netoAPagar            Decimal      @db.Decimal(12, 2)

  // — Cargas Sociales Empleador —
  contribJubilacion     Decimal      @db.Decimal(12, 2)
  contribObraSocial     Decimal      @db.Decimal(12, 2)
  contribLey19032       Decimal      @db.Decimal(12, 2)
  contribART            Decimal      @db.Decimal(12, 2)
  totalContribuciones   Decimal      @db.Decimal(12, 2)
  costoTotalEmpleador   Decimal      @db.Decimal(12, 2)

  // — Fechas —
  fechaLiquidacion      DateTime?
  fechaPago             DateTime?

  // — Días —
  diasTrabajados        Int          @default(30)
  diasAusencia          Int          @default(0)

  userId                String?

  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  @@unique([empleadoId, tipo, periodo])
  @@index([periodo])
  @@index([estado])
  @@map("recibos_sueldo")
}

model DocumentoEmpleado {
  id               String                @id @default(cuid())

  empleadoId       String
  empleado         Empleado              @relation(fields: [empleadoId], references: [id], onDelete: Cascade)

  tipo             TipoDocumentoEmpleado
  nombre           String
  archivoUrl       String?
  fechaVencimiento DateTime?
  notas            String?

  createdAt        DateTime              @default(now())

  @@index([empleadoId])
  @@map("documentos_empleado")
}

// ═══════════════════════════════════════════════════════════════
// CONCILIACIÓN BANCARIA
// ═══════════════════════════════════════════════════════════════

enum TipoCuentaBancaria {
  CORRIENTE
  AHORRO
  MERCADOPAGO
}

enum EstadoConciliacion {
  EN_PROCESO
  COMPLETADA
  ANULADA
}

enum EstadoMatch {
  PROPUESTO       // El algoritmo lo sugirió
  APROBADO        // El usuario lo confirmó
  RECHAZADO       // El usuario lo descartó
}

enum TipoMatch {
  EXACTO          // Monto + referencia exactos
  APROXIMADO      // Monto con tolerancia
  REFERENCIA      // Match por texto de referencia
  MANUAL          // El usuario lo vinculó manualmente
}

model CuentaBancaria {
  id              String              @id @default(cuid())
  nombre          String              // "Santander CC Pesos", "MercadoPago"
  banco           String              // "Santander", "BIND", "MercadoPago"
  tipo            TipoCuentaBancaria
  numero          String?             // Número de cuenta
  cbu             String?             @unique
  alias           String?
  moneda          String              @default("ARS")
  saldoActual     Decimal             @db.Decimal(14, 2)  @default(0)
  activa          Boolean             @default(true)

  // ── Contabilidad ──
  cuentaContableId String?            // FK a CuentaContable (ej: 1.1.01.002 Banco MP)

  extractos       ExtractoBancario[]
  conciliaciones  Conciliacion[]

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@map("cuentas_bancarias")
}

model ExtractoBancario {
  id              String          @id @default(cuid())

  cuentaBancariaId String
  cuentaBancaria  CuentaBancaria  @relation(fields: [cuentaBancariaId], references: [id])

  // ── Datos del movimiento bancario ──
  fecha           DateTime
  descripcion     String          // Texto del extracto: "TRF DE PEREZ JUAN"
  referencia      String?         // Número de referencia/comprobante del banco
  monto           Decimal         @db.Decimal(14, 2)  // Positivo = ingreso, Negativo = egreso
  saldo           Decimal?        @db.Decimal(14, 2)  // Saldo después del movimiento

  // ── Estado de conciliación ──
  conciliado      Boolean         @default(false)
  conciliacionMatchId String?     // FK al match que lo concilió

  // ── Import ──
  importId        String?         // ID del batch de importación
  lineaOriginal   String?         // Línea CSV original para auditoría

  createdAt       DateTime        @default(now())

  @@index([cuentaBancariaId])
  @@index([fecha])
  @@index([conciliado])
  @@map("extractos_bancarios")
}

model Conciliacion {
  id              String              @id @default(cuid())
  numero          String              @unique  // "CONC-2026-00001"

  cuentaBancariaId String
  cuentaBancaria  CuentaBancaria      @relation(fields: [cuentaBancariaId], references: [id])

  estado          EstadoConciliacion  @default(EN_PROCESO)
  periodoDesde    DateTime
  periodoHasta    DateTime

  // ── Estadísticas ──
  totalExtractos  Int                 @default(0)
  totalConciliados Int                @default(0)
  totalNoConciliados Int              @default(0)
  diferencia      Decimal             @db.Decimal(14, 2)  @default(0)

  // ── Proceso ──
  fechaProceso    DateTime?
  completadaPor   String?
  fechaCompletada DateTime?
  observaciones   String?

  matches         ConciliacionMatch[]

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([cuentaBancariaId])
  @@index([estado])
  @@map("conciliaciones")
}

model ConciliacionMatch {
  id              String        @id @default(cuid())

  conciliacionId  String
  conciliacion    Conciliacion  @relation(fields: [conciliacionId], references: [id], onDelete: Cascade)

  // ── Extracto bancario ──
  extractoId      String

  // ── Movimiento interno ──
  entidadTipo     String        // "PagoMercadoPago", "Gasto", "FacturaCompra", "ReciboSueldo"
  entidadId       String
  entidadLabel    String?       // "Pago MP-123456 — $25.000"

  // ── Match ──
  tipoMatch       TipoMatch
  estado          EstadoMatch   @default(PROPUESTO)
  confianza       Int           // 0-100 (% de confianza del match)

  montoBanco      Decimal       @db.Decimal(14, 2)
  montoSistema    Decimal       @db.Decimal(14, 2)
  diferencia      Decimal       @db.Decimal(14, 2)  @default(0)

  // ── Aprobación ──
  aprobadoPor     String?
  fechaAprobacion DateTime?
  motivoRechazo   String?

  createdAt       DateTime      @default(now())

  @@index([conciliacionId])
  @@index([estado])
  @@map("conciliacion_matches")
}

// ═══════════════════════════════════════════════════════════════
// MONITOR + DIAGNÓSTICO
// ═══════════════════════════════════════════════════════════════

enum NivelLog {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum EstadoDiagnostico {
  PENDIENTE
  EN_EJECUCION
  COMPLETADO
  ERROR
}

model EventoSistema {
  id              String      @id @default(cuid())

  // ── Evento ──
  tipo            String      // "payment.approve", "contract.create", etc.
  payload         Json?       // Datos del evento (sanitizados, sin PII)

  // ── Origen ──
  origenModulo    String      // "pagos", "contratos", "flota", etc.
  origenUsuario   String?     // userId que disparó la acción
  origenAccion    String?     // "POST /api/pagos/[id]/aprobar"

  // ── Handlers ──
  handlersEjecutados  Int     @default(0)
  handlersExitosos    Int     @default(0)
  handlersFallidos    Int     @default(0)

  // ── Timing ──
  duracionMs      Int?        // Duración total de procesamiento

  // ── Nivel ──
  nivel           NivelLog    @default(INFO)
  error           String?     // Mensaje de error si falló algún handler
  stackTrace      String?     // Stack trace del error

  createdAt       DateTime    @default(now())

  @@index([tipo])
  @@index([nivel])
  @@index([createdAt])
  @@index([origenModulo])
  @@map("eventos_sistema")
}

model DiagnosticoEjecucion {
  id              String              @id @default(cuid())

  estado          EstadoDiagnostico   @default(PENDIENTE)

  // ── Resultados ──
  checksTotal     Int                 @default(0)
  checksOk        Int                 @default(0)
  checksWarning   Int                 @default(0)
  checksError     Int                 @default(0)

  resultados      Json?               // Array de resultados detallados

  // ── Timing ──
  duracionMs      Int?

  ejecutadoPor    String?             // userId

  createdAt       DateTime            @default(now())

  @@index([estado])
  @@map("diagnostico_ejecuciones")
}

// ═══════════════════════════════════════════════════════════════
// ALERTAS
// ═══════════════════════════════════════════════════════════════

enum TipoAlerta {
  CONTRATO_POR_VENCER
  CUOTA_VENCIDA
  CUOTA_POR_VENCER
  PAGO_RECIBIDO
  MANTENIMIENTO_PROGRAMADO
  STOCK_BAJO
  ANOMALIA_DETECTADA
  EMBARQUE_ACTUALIZADO
  CONCILIACION_PENDIENTE
  SOLICITUD_NUEVA
  DOCUMENTO_POR_VENCER
  MENSAJE_NUEVO
  EMAIL_ENTRANTE
  SISTEMA
}

enum PrioridadAlerta {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

model Alerta {
  id              String          @id @default(cuid())

  tipo            TipoAlerta
  prioridad       PrioridadAlerta @default(MEDIA)

  titulo          String
  mensaje         String

  // ── Módulo y entidad ──
  modulo          String
  entidadTipo     String?
  entidadId       String?

  // ── Destinatario ──
  usuarioId       String

  // ── Estado ──
  leida           Boolean         @default(false)
  fechaLeida      DateTime?

  // ── Acción ──
  accionUrl       String?
  accionLabel     String?

  createdAt       DateTime        @default(now())

  @@index([usuarioId, leida])
  @@index([tipo])
  @@index([createdAt])
  @@map("alertas")
}

// ══════════════════════════════════════════════════════════════
// E-Commerce Repuestos
// ══════════════════════════════════════════════════════════════

enum EstadoOrdenVenta {
  PENDIENTE_PAGO
  PAGADA
  EN_PREPARACION
  LISTA_RETIRO
  ENVIADA
  ENTREGADA
  CANCELADA
}

enum MetodoEntrega {
  RETIRO_LOCAL
  ENVIO
}

model OrdenVentaRepuesto {
  id                String            @id @default(cuid())
  numero            Int               @unique @default(autoincrement())

  // ── Cliente ──
  nombreCliente     String
  emailCliente      String
  telefonoCliente   String?
  direccionEnvio    String?

  // ── Entrega ──
  metodoEntrega     MetodoEntrega     @default(RETIRO_LOCAL)

  // ── Totales ──
  subtotal          Decimal           @db.Decimal(12, 2)
  descuento         Decimal           @db.Decimal(12, 2) @default(0)
  iva               Decimal           @db.Decimal(12, 2)
  total             Decimal           @db.Decimal(12, 2)

  // ── Estado ──
  estado            EstadoOrdenVenta  @default(PENDIENTE_PAGO)

  // ── MercadoPago ──
  mpPreferenceId    String?
  mpPaymentId       String?

  // ── Notas ──
  notas             String?

  // ── Items ──
  items             ItemVentaRepuesto[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([estado])
  @@index([emailCliente])
  @@index([createdAt])
  @@map("ordenes_venta_repuestos")
}

model ItemVentaRepuesto {
  id                String              @id @default(cuid())

  ordenId           String
  orden             OrdenVentaRepuesto  @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  repuestoId        String
  repuesto          Repuesto            @relation(fields: [repuestoId], references: [id])

  // ── Snapshot al momento de la compra ──
  codigoSnapshot    String
  nombreSnapshot    String
  precioUnitario    Decimal             @db.Decimal(12, 2)

  cantidad          Int
  subtotal          Decimal             @db.Decimal(12, 2)

  @@index([ordenId])
  @@index([repuestoId])
  @@map("items_venta_repuestos")
}

// ═══════════════════════════════════════════════════════════════
// CHAT
// ═══════════════════════════════════════════════════════════════

model MensajeChat {
  id              String      @id @default(cuid())

  // ── Canal ──
  contratoId      String

  // ── Autor ──
  userId          String
  userName        String
  userRole        String      // "ADMIN", "OPERADOR", "CLIENTE", "SISTEMA"

  // ── Contenido ──
  texto           String

  // ── Estado ──
  leido           Boolean     @default(false)
  fechaLeido      DateTime?

  // ── Metadata ──
  tipo            String      @default("texto") // "texto", "sistema"

  createdAt       DateTime    @default(now())

  @@index([contratoId, createdAt])
  @@index([contratoId, leido])
  @@map("mensajes_chat")
}

// ═══════════════════════════════════════════════════════════════
// COMUNICACIÓN CORPORATIVA
// ═══════════════════════════════════════════════════════════════

enum TipoContacto {
  PROVEEDOR
  CONTADOR
  ABOGADO
  DESPACHANTE
  ASEGURADORA
  TALLER_EXTERNO
  CLIENTE_POTENCIAL
  OTRO
}

enum EstadoConversacion {
  ABIERTA
  RESUELTA
  ARCHIVADA
}

enum DireccionMensaje {
  ENTRANTE
  SALIENTE
  INTERNO
  NOTA_IA
}

enum EstadoMensaje {
  BORRADOR
  PENDIENTE_APROBACION
  APROBADO
  ENVIADO
  ENTREGADO
  REBOTADO
  FALLIDO
}

enum EstadoAprobacion {
  PENDIENTE
  APROBADO
  RECHAZADO
  EDITADO
}

model Contacto {
  id              String          @id @default(cuid())

  nombre          String
  email           String          @unique
  empresa         String?
  tipo            TipoContacto
  telefono        String?
  notas           String?
  activo          Boolean         @default(true)

  conversaciones  ConversacionContacto[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([tipo])
  @@index([email])
  @@map("contactos_comunicacion")
}

model Conversacion {
  id              String                  @id @default(cuid())

  asunto          String
  estado          EstadoConversacion      @default(ABIERTA)

  // ── Metadata ──
  prioridad       String                  @default("MEDIA")
  etiquetas       String[]                @default([])

  // ── IA ──
  resumenIA       String?

  // ── Relaciones ──
  contactos       ConversacionContacto[]
  mensajes        MensajeComunicacion[]

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@index([estado])
  @@index([updatedAt])
  @@map("conversaciones")
}

model ConversacionContacto {
  id              String          @id @default(cuid())

  conversacionId  String
  conversacion    Conversacion    @relation(fields: [conversacionId], references: [id], onDelete: Cascade)

  contactoId      String
  contacto        Contacto        @relation(fields: [contactoId], references: [id])

  @@unique([conversacionId, contactoId])
  @@map("conversacion_contactos")
}

model MensajeComunicacion {
  id              String              @id @default(cuid())

  conversacionId  String
  conversacion    Conversacion        @relation(fields: [conversacionId], references: [id], onDelete: Cascade)

  // ── Dirección y estado ──
  direccion       DireccionMensaje
  estado          EstadoMensaje       @default(BORRADOR)

  // ── Email ──
  de              String
  para            String[]
  cc              String[]            @default([])
  asunto          String
  cuerpo          String
  cuerpoTexto     String?

  // ── Email tracking ──
  resendMessageId String?
  inReplyTo       String?
  messageId       String?

  // ── IA ──
  analisisIA      Json?
  borradorIA      String?

  // ── Aprobación ──
  aprobacion      AprobacionMensaje?

  // ── Metadata ──
  userId          String?

  adjuntos        AdjuntoMensaje[]

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([conversacionId, createdAt])
  @@index([estado])
  @@index([direccion])
  @@map("mensajes_comunicacion")
}

model AdjuntoMensaje {
  id              String              @id @default(cuid())

  mensajeId       String
  mensaje         MensajeComunicacion @relation(fields: [mensajeId], references: [id], onDelete: Cascade)

  nombre          String
  tipo            String
  tamanio         Int
  url             String

  createdAt       DateTime            @default(now())

  @@map("adjuntos_mensaje")
}

model AprobacionMensaje {
  id              String              @id @default(cuid())

  mensajeId       String              @unique
  mensaje         MensajeComunicacion @relation(fields: [mensajeId], references: [id], onDelete: Cascade)

  estado          EstadoAprobacion    @default(PENDIENTE)

  aprobadoPor     String?
  comentario      String?
  textoEditado    String?

  fechaAprobacion DateTime?

  createdAt       DateTime            @default(now())

  @@map("aprobaciones_mensaje")
}

model PlantillaMensaje {
  id              String      @id @default(cuid())

  nombre          String
  asunto          String
  cuerpo          String
  tipo            String?
  activa          Boolean     @default(true)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("plantillas_mensaje")
}

model ReglaAutonomia {
  id              String      @id @default(cuid())

  nombre          String
  descripcion     String?

  // ── Condiciones ──
  tipoContacto    TipoContacto?
  palabrasClave   String[]    @default([])
  prioridadMaxima String      @default("BAJA")

  // ── Acción ──
  accion          String
  plantillaId     String?

  activa          Boolean     @default(true)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("reglas_autonomia")
}

// ═══════════════════════════════════════════════════════════════
// RED DE TALLERES — SOLICITUDES, EVALUACIONES, CONVENIOS
// ═══════════════════════════════════════════════════════════════

model SolicitudTaller {
  id                    String   @id @default(cuid())
  estado                EstadoSolicitudTaller @default(BORRADOR)

  // Datos del negocio
  nombreTaller          String
  razonSocial           String?
  cuit                  String?
  direccion             String
  ciudad                String
  provincia             String
  codigoPostal          String?
  telefono              String
  email                 String
  sitioWeb              String?

  // Contacto principal
  contactoNombre        String
  contactoCargo         String?
  contactoCelular       String?

  // Capacidad
  cantidadMecanicos     Int       @default(1)
  especialidades        String[]  @default([])
  marcasExperiencia     String[]  @default([])
  capacidadOTMes        Int?
  horariosAtencion      String?

  // Infraestructura
  superficieM2          Int?
  cantidadElevadores    Int?      @default(0)
  tieneDeposito         Boolean   @default(false)
  tieneEstacionamiento  Boolean   @default(false)

  // Documentos (URLs Supabase)
  docCuit               String?
  docHabilitacion       String?
  docSeguro             String?
  docFotos              String[]  @default([])
  docOtros              String[]  @default([])

  // Geo
  latitud               Float?
  longitud              Float?

  // Evaluación
  scoreTotal            Float?
  evaluaciones          EvaluacionSolicitud[]
  notasInternas         String?

  // Token público para seguimiento
  tokenPublico          String    @unique @default(cuid())

  // Convenio
  convenioId            String?   @unique
  convenio              ConvenioTaller? @relation(fields: [convenioId], references: [id])

  // Taller creado al activar
  tallerId              String?   @unique
  taller                Taller?   @relation(fields: [tallerId], references: [id])

  // Metadata
  motivoRechazo         String?
  fechaRecepcion        DateTime?
  fechaEvaluacion       DateTime?
  fechaAprobacion       DateTime?
  creadoPor             String?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([estado])
  @@index([provincia])
  @@map("solicitudes_taller")
}

model EvaluacionSolicitud {
  id              String   @id @default(cuid())
  solicitudId     String
  solicitud       SolicitudTaller @relation(fields: [solicitudId], references: [id], onDelete: Cascade)
  categoria       CategoriaEvaluacion
  puntaje         Int      // 0-10
  peso            Float    @default(1.0)
  observaciones   String?
  evaluadorId     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([solicitudId, categoria])
  @@map("evaluaciones_solicitud")
}

model ConvenioTaller {
  id                String   @id @default(cuid())
  tarifaHoraBase    Decimal  @db.Decimal(12,2)
  margenRepuestos   Decimal? @db.Decimal(5,2)
  plazoFacturaDias  Int      @default(30)
  fechaInicio       DateTime
  fechaFin          DateTime?
  renovacionAuto    Boolean  @default(true)
  zonaCobertura     String?
  otMaxMes          Int?
  documentoUrl      String?
  firmadoDigital    Boolean  @default(false)
  fechaFirma        DateTime?
  solicitud         SolicitudTaller?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("convenios_taller")
}

enum EstadoAsignacion {
  PENDIENTE
  ACEPTADA
  RECHAZADA
  EXPIRADA
  CANCELADA
}

model AsignacionOT {
  id              String      @id @default(cuid())
  ordenTrabajoId  String
  tallerId        String
  taller          Taller      @relation(fields: [tallerId], references: [id])
  estado          EstadoAsignacion @default(PENDIENTE)

  // SLA
  fechaLimite     DateTime    // Deadline para aceptar/rechazar
  fechaRespuesta  DateTime?   // Cuando respondió

  // Respuesta del taller
  motivoRechazo   String?
  precioEstimado  Decimal?    @db.Decimal(12,2)
  tiempoEstimado  Int?        // minutos
  notasTaller     String?
  confirmRepuestos Boolean?   // Taller confirma que tiene los repuestos

  // Metadata
  asignadoPor     String?     // userId del admin que asignó

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([ordenTrabajoId])
  @@index([tallerId])
  @@index([estado])
  @@map("asignaciones_ot")
}
