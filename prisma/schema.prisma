generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ═══════════════════════════════════════════════════════════════
// AUTH & USERS
// ═══════════════════════════════════════════════════════════════

enum Role {
  ADMIN
  OPERADOR
  CLIENTE
  CONTADOR
  RRHH_MANAGER
  COMERCIAL
  VIEWER
}

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String
  image            String?
  provider         String    @default("credentials")
  password         String?
  phone            String?
  phoneVerifiedAt  DateTime?
  role             Role      @default(CLIENTE)
  totpSecret       String?
  totpEnabled      Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  profiles         UserProfile[]
  cliente          Cliente?

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ═══════════════════════════════════════════════════════════════
// PERMISOS
// ═══════════════════════════════════════════════════════════════

model PermissionProfile {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  grants      PermissionGrant[]
  users       UserProfile[]

  @@map("permission_profiles")
}

model PermissionGrant {
  id          String  @id @default(cuid())
  profileId   String
  profile     PermissionProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  operationId String

  canView     Boolean @default(false)
  canCreate   Boolean @default(false)
  canExecute  Boolean @default(false)
  canApprove  Boolean @default(false)

  @@unique([profileId, operationId])
  @@index([operationId])
  @@map("permission_grants")
}

model UserProfile {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  profileId String
  profile   PermissionProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([userId, profileId])
  @@map("user_profiles")
}

// ═══════════════════════════════════════════════════════════════
// EVENTOS
// ═══════════════════════════════════════════════════════════════

model BusinessEvent {
  id          String   @id @default(cuid())
  operationId String
  entityType  String
  entityId    String
  payload     Json?
  userId      String?
  status      String   @default("COMPLETED")
  error       String?
  createdAt   DateTime @default(now())

  @@index([operationId])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("business_events")
}

// ═══════════════════════════════════════════════════════════════
// FLOTA — MOTOS
// ═══════════════════════════════════════════════════════════════

enum EstadoMoto {
  EN_DEPOSITO
  EN_PATENTAMIENTO
  DISPONIBLE
  RESERVADA
  ALQUILADA
  EN_SERVICE
  EN_REPARACION
  INMOVILIZADA
  RECUPERACION
  BAJA_TEMP
  BAJA_DEFINITIVA
  TRANSFERIDA
}

enum TipoMoto {
  NAKED
  TOURING
  SPORT
  SCOOTER
  CUSTOM
}

enum EstadoPatentamiento {
  PENDIENTE
  EN_TRAMITE
  COMPLETADO
  RECHAZADO
}

enum EstadoSeguro {
  SIN_SEGURO
  EN_TRAMITE
  ACTIVO
  VENCIDO
  SUSPENDIDO
}

enum EstadoLegalMoto {
  LIMPIO
  INHIBIDA
  SECUESTRADA
  EN_JUICIO
}

enum TipoBaja {
  ROBO
  SINIESTRO
  VENTA
  CHATARRA
  DEVOLUCION_FABRICANTE
}

enum TipoDocumentoMoto {
  TITULO
  CEDULA_VERDE
  CEDULA_AZUL
  POLIZA_SEGURO
  VTV
  FORMULARIO_08
  FORMULARIO_12
  FORMULARIO_13
  FOTO_GENERAL
  FOTO_DANO
  INFORME_MECANICO
  OTRO
}

enum MetodoAmortizacion {
  LINEAL
}

enum FuenteKm {
  MANUAL
  GPS
  SERVICE
  INSPECCION
}

model Moto {
  id              String       @id @default(cuid())

  // ── Identificación ──
  marca           String
  modelo          String
  anio            Int
  patente         String?      @unique
  numMotor        String?      @unique
  numChasis       String?      @unique
  color           String?
  cilindrada      Int?
  tipo            TipoMoto     @default(NAKED)

  // ── Estado operativo ──
  estado          EstadoMoto   @default(EN_DEPOSITO)
  estadoAnterior  EstadoMoto?

  // ── Kilometraje ──
  km              Int          @default(0)
  kmUltimaLectura DateTime?

  // ── Patentamiento ──
  estadoPatentamiento  EstadoPatentamiento @default(PENDIENTE)
  fechaPatentamiento   DateTime?
  tramitePatente       String?

  // ── Seguro ──
  estadoSeguro      EstadoSeguro @default(SIN_SEGURO)
  aseguradora       String?
  numPoliza         String?
  fechaInicioSeguro DateTime?
  fechaFinSeguro    DateTime?

  // ── Legal ──
  estadoLegal      EstadoLegalMoto @default(LIMPIO)

  // ── Financiero / Compra ──
  precioCompra      Decimal?   @db.Decimal(12, 2)
  fechaCompra       DateTime?
  proveedorCompra   String?
  numFacturaCompra  String?
  monedaCompra      String     @default("ARS")
  cotizacionCompra  Decimal?   @db.Decimal(12, 2)

  // ── Alquiler ──
  precioAlquilerMensual  Decimal?  @db.Decimal(12, 2)

  // ── Amortización ──
  metodoAmortizacion  MetodoAmortizacion @default(LINEAL)
  vidaUtilMeses       Int        @default(60)
  valorResidual       Decimal    @default(0) @db.Decimal(12, 2)
  fechaAltaContable   DateTime?

  // ── Ubicación ──
  ubicacion        String?

  // ── Imagen ──
  imagenUrl        String?

  // ── Notas ──
  notas            String?

  // ── Metadata ──
  creadoPor        String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  // ── Relaciones ──
  documentos       DocumentoMoto[]
  historialEstados HistorialEstadoMoto[]
  lecturasKm       LecturaKm[]
  baja             BajaMoto?
  amortizaciones   Amortizacion[]
  contratos        Contrato[]
  solicitudes      Solicitud[]
  mantenimientos   MantenimientoProgramado[] @relation("MantenimientosMoto")

  @@index([estado])
  @@index([marca, modelo])
  @@index([patente])
  @@index([tipo])
  @@map("motos")
}

model DocumentoMoto {
  id        String             @id @default(cuid())
  motoId    String
  moto      Moto               @relation(fields: [motoId], references: [id], onDelete: Cascade)
  tipo      TipoDocumentoMoto
  nombre    String
  url       String
  tamano    Int?
  mimeType  String?
  notas     String?
  creadoPor String?
  createdAt DateTime           @default(now())

  @@index([motoId])
  @@map("documentos_moto")
}

model HistorialEstadoMoto {
  id             String     @id @default(cuid())
  motoId         String
  moto           Moto       @relation(fields: [motoId], references: [id], onDelete: Cascade)
  estadoAnterior EstadoMoto
  estadoNuevo    EstadoMoto
  motivo         String?
  userId         String?
  createdAt      DateTime   @default(now())

  @@index([motoId])
  @@index([createdAt])
  @@map("historial_estado_moto")
}

model LecturaKm {
  id        String    @id @default(cuid())
  motoId    String
  moto      Moto      @relation(fields: [motoId], references: [id], onDelete: Cascade)
  km        Int
  fuente    FuenteKm  @default(MANUAL)
  notas     String?
  userId    String?
  createdAt DateTime  @default(now())

  @@index([motoId])
  @@index([createdAt])
  @@map("lecturas_km")
}

model BajaMoto {
  id              String   @id @default(cuid())
  motoId          String   @unique
  moto            Moto     @relation(fields: [motoId], references: [id], onDelete: Cascade)
  tipo            TipoBaja
  fecha           DateTime @default(now())
  motivo          String
  montoRecuperado Decimal? @db.Decimal(12, 2)
  numDenuncia     String?
  userId          String?
  createdAt       DateTime @default(now())

  @@map("bajas_moto")
}

model Amortizacion {
  id          String   @id @default(cuid())
  motoId      String
  moto        Moto     @relation(fields: [motoId], references: [id], onDelete: Cascade)
  periodo     String
  monto       Decimal  @db.Decimal(12, 2)
  acumulado   Decimal  @db.Decimal(12, 2)
  valorLibros Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now())

  @@unique([motoId, periodo])
  @@index([motoId])
  @@index([periodo])
  @@map("amortizaciones")
}

// ═══════════════════════════════════════════════════════════════
// CONFIGURACION EMPRESA
// ═══════════════════════════════════════════════════════════════

enum CondicionIva {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTISTA
  EXENTO
  CONSUMIDOR_FINAL
}

model ConfiguracionEmpresa {
  id                String       @id @default(cuid())
  razonSocial       String       @default("MotoLibre S.A.")
  cuit              String       @default("30-71617222-4")
  direccion         String       @default("Tucumán 141, Piso 4, Of. I, CABA")
  telefono          String       @default("")
  email             String       @default("")
  condicionIva      CondicionIva @default(RESPONSABLE_INSCRIPTO)
  inicioActividades DateTime?
  logo              String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@map("configuracion_empresa")
}

// ═══════════════════════════════════════════════════════════════
// CLIENTES
// ═══════════════════════════════════════════════════════════════

enum EstadoCliente {
  PENDIENTE
  EN_REVISION
  APROBADO
  RECHAZADO
  SUSPENDIDO
  BAJA
}

enum TipoDocumentoCliente {
  DNI_FRENTE
  DNI_DORSO
  LICENCIA_CONDUCIR_FRENTE
  LICENCIA_CONDUCIR_DORSO
  COMPROBANTE_DOMICILIO
  RECIBO_SUELDO
  CONSTANCIA_MONOTRIBUTO
  SELFIE
  CONTRATO_FIRMADO
  OTRO
}

enum TipoLicencia {
  A1
  A2
  A3
}

model Cliente {
  id              String         @id @default(cuid())

  // ── Datos personales ──
  nombre          String
  apellido        String
  email           String         @unique
  telefono        String
  telefonoAlt     String?
  dni             String         @unique
  fechaNacimiento DateTime?
  genero          String?
  nacionalidad    String?        @default("Argentina")

  // ── Licencia de conducir ──
  tipoLicencia    TipoLicencia?
  numLicencia     String?
  fechaVencLicencia DateTime?

  // ── Dirección ──
  calle           String?
  numero          String?
  piso            String?
  depto           String?
  localidad       String?
  provincia       String?        @default("CABA")
  codigoPostal    String?

  // ── Fiscal ──
  cuit            String?        @unique
  condicionIva    CondicionIva   @default(CONSUMIDOR_FINAL)

  // ── Trabajo / Delivery ──
  plataformas     String?
  experienciaMeses Int?

  // ── Estado y aprobación ──
  estado          EstadoCliente  @default(PENDIENTE)
  motivoRechazo   String?
  fechaAprobacion DateTime?
  aprobadoPor     String?

  // ── Scoring ──
  score           Int?           @default(0)

  // ── Referencia ──
  comoNosConocio  String?
  referidoPor     String?

  // ── Imagen ──
  fotoUrl         String?

  // ── Notas internas ──
  notas           String?

  // ── Relación con User (si tiene cuenta) ──
  userId          String?        @unique
  user            User?          @relation(fields: [userId], references: [id])

  // ── Metadata ──
  creadoPor       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // ── Relaciones ──
  documentos      DocumentoCliente[]
  puntajes        PuntajeRider[]
  contratos       Contrato[]
  solicitudes     Solicitud[]
  mantenimientos  MantenimientoProgramado[]

  @@index([estado])
  @@index([email])
  @@index([dni])
  @@index([apellido, nombre])
  @@map("clientes")
}

model DocumentoCliente {
  id                String               @id @default(cuid())
  clienteId         String
  cliente           Cliente              @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  tipo              TipoDocumentoCliente
  nombre            String
  url               String
  tamano            Int?
  mimeType          String?
  verificado        Boolean              @default(false)
  verificadoPor     String?
  fechaVerificacion DateTime?
  notas             String?
  createdAt         DateTime             @default(now())

  @@index([clienteId])
  @@map("documentos_cliente")
}

model PuntajeRider {
  id        String   @id @default(cuid())
  clienteId String
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  categoria String
  valor     Int
  motivo    String?
  userId    String?
  createdAt DateTime @default(now())

  @@index([clienteId])
  @@map("puntajes_rider")
}

// ═══════════════════════════════════════════════════════════════
// CONTRATOS
// ═══════════════════════════════════════════════════════════════

enum EstadoContrato {
  BORRADOR
  ACTIVO
  FINALIZADO
  CANCELADO
  FINALIZADO_COMPRA
  VENCIDO
}

enum FrecuenciaPago {
  SEMANAL
  QUINCENAL
  MENSUAL
}

enum EstadoCuota {
  PENDIENTE
  PAGADA
  PARCIAL
  VENCIDA
  CANCELADA
}

model Contrato {
  id              String          @id @default(cuid())

  // ── Partes ──
  clienteId       String
  cliente         Cliente         @relation(fields: [clienteId], references: [id])
  motoId          String
  moto            Moto            @relation(fields: [motoId], references: [id])

  // ── Estado ──
  estado          EstadoContrato  @default(BORRADOR)

  // ── Fechas ──
  fechaInicio      DateTime?
  fechaFin         DateTime?
  fechaFinReal     DateTime?
  fechaActivacion  DateTime?
  fechaCancelacion DateTime?

  // ── Pago ──
  frecuenciaPago   FrecuenciaPago  @default(MENSUAL)
  montoPeriodo     Decimal         @db.Decimal(12, 2)
  deposito         Decimal         @default(0) @db.Decimal(12, 2)
  depositoDevuelto Boolean         @default(false)
  duracionMeses    Int             @default(12)

  // ── Opción a compra ──
  tieneOpcionCompra Boolean        @default(false)
  precioCompra      Decimal?       @db.Decimal(12, 2)
  fechaEjercicio    DateTime?

  // ── Renovación ──
  renovacionAuto     Boolean        @default(false)
  contratoAnteriorId String?
  contratoAnterior   Contrato?      @relation("Renovacion", fields: [contratoAnteriorId], references: [id])
  contratosRenovados Contrato[]     @relation("Renovacion")

  // ── Cancelación ──
  motivoCancelacion String?
  penalidad         Decimal?        @db.Decimal(12, 2)

  // ── Notas ──
  notas             String?

  // ── Metadata ──
  creadoPor         String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // ── Lease-to-own ──
  esLeaseToOwn      Boolean         @default(false)
  transferidaAt     DateTime?

  // ── Relaciones ──
  cuotas            Cuota[]
  solicitud         Solicitud?
  mantenimientos    MantenimientoProgramado[]

  @@index([clienteId])
  @@index([motoId])
  @@index([estado])
  @@index([fechaInicio])
  @@map("contratos")
}

model Cuota {
  id               String      @id @default(cuid())
  contratoId       String
  contrato         Contrato    @relation(fields: [contratoId], references: [id], onDelete: Cascade)

  numero           Int
  monto            Decimal     @db.Decimal(12, 2)
  fechaVencimiento DateTime

  estado           EstadoCuota @default(PENDIENTE)
  fechaPago        DateTime?
  montoPagado      Decimal?    @db.Decimal(12, 2)

  notas            String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@unique([contratoId, numero])
  @@index([contratoId])
  @@index([estado])
  @@index([fechaVencimiento])
  @@map("cuotas")
}

// ═══════════════════════════════════════════════════════════════
// PRICING — TARIFAS DE ALQUILER
// ═══════════════════════════════════════════════════════════════

enum CondicionMoto {
  NUEVA
  USADA
}

enum PlanDuracion {
  MESES_3
  MESES_6
  MESES_9
  MESES_12
  MESES_24
}

model TarifaAlquiler {
  id              String          @id @default(cuid())

  // ── Dimensiones ──
  marca           String
  modelo          String
  condicion       CondicionMoto
  plan            PlanDuracion
  frecuencia      FrecuenciaPago

  // ── Precio ──
  precio          Decimal         @db.Decimal(12, 2)

  // ── Validez ──
  activo          Boolean         @default(true)
  vigenciaDesde   DateTime        @default(now())
  vigenciaHasta   DateTime?

  // ── Metadata ──
  creadoPor       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([marca, modelo, condicion, plan, frecuencia, vigenciaDesde])
  @@index([marca, modelo])
  @@index([condicion, plan, frecuencia])
  @@index([activo])
  @@map("tarifas_alquiler")
}

// ═══════════════════════════════════════════════════════════════
// SOLICITUDES DE ALQUILER
// ═══════════════════════════════════════════════════════════════

enum EstadoSolicitud {
  PAGO_PENDIENTE
  PAGADA
  EN_EVALUACION
  APROBADA
  EN_ESPERA
  ASIGNADA
  ENTREGADA
  RECHAZADA
  CANCELADA
  REEMBOLSADA
}

model Solicitud {
  id                String           @id @default(cuid())

  // ── Cliente ──
  clienteId         String
  cliente           Cliente          @relation(fields: [clienteId], references: [id])

  // ── Qué quiere ──
  marcaDeseada      String
  modeloDeseado     String
  condicionDeseada  CondicionMoto
  plan              PlanDuracion

  // ── Precios ──
  precioSemanal     Decimal          @db.Decimal(12, 2)
  precioMensual     Decimal?         @db.Decimal(12, 2)
  montoPrimerMes    Decimal          @db.Decimal(12, 2)

  // ── Estado ──
  estado            EstadoSolicitud  @default(PAGO_PENDIENTE)

  // ── Pago adelantado ──
  mpPaymentId       String?
  mpPreferenceId    String?
  fechaPago         DateTime?

  // ── Evaluación ──
  evaluadoPor       String?
  fechaEvaluacion   DateTime?
  motivoRechazo     String?

  // ── Asignación ──
  motoAsignadaId    String?
  moto              Moto?            @relation(fields: [motoAsignadaId], references: [id])
  fechaAsignacion   DateTime?

  // ── Entrega ──
  fechaEntrega      DateTime?

  // ── Contrato generado ──
  contratoId        String?          @unique
  contrato          Contrato?        @relation(fields: [contratoId], references: [id])

  // ── Lista de espera ──
  prioridadEspera   Int?

  // ── Notas ──
  notas             String?

  // ── Metadata ──
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([clienteId])
  @@index([estado])
  @@index([marcaDeseada, modeloDeseado])
  @@index([prioridadEspera])
  @@map("solicitudes")
}

// ═══════════════════════════════════════════════════════════════
// MANTENIMIENTOS PROGRAMADOS
// ═══════════════════════════════════════════════════════════════

enum EstadoMantenimiento {
  PROGRAMADO
  NOTIFICADO
  COMPLETADO
  NO_ASISTIO
  CANCELADO
  REPROGRAMADO
}

model MantenimientoProgramado {
  id              String               @id @default(cuid())

  // ── Relaciones ──
  contratoId      String
  contrato        Contrato             @relation(fields: [contratoId], references: [id])
  motoId          String
  moto            Moto                 @relation("MantenimientosMoto", fields: [motoId], references: [id])
  clienteId       String
  cliente         Cliente              @relation(fields: [clienteId], references: [id])

  // ── Programación ──
  numero          Int
  fechaProgramada DateTime
  fechaRealizada  DateTime?

  // ── Estado ──
  estado          EstadoMantenimiento  @default(PROGRAMADO)
  notas           String?
  notasOperador   String?

  // ── Si se reprogramó ──
  fechaOriginal        DateTime?
  motivoReprogramacion String?

  // ── Metadata ──
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@unique([contratoId, numero])
  @@index([contratoId])
  @@index([motoId])
  @@index([clienteId])
  @@index([fechaProgramada])
  @@index([estado])
  @@map("mantenimientos_programados")
}
