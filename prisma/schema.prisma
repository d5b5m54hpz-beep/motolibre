generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ═══════════════════════════════════════════════════════════════
// AUTH & USERS
// ═══════════════════════════════════════════════════════════════

enum Role {
  ADMIN
  OPERADOR
  CLIENTE
  CONTADOR
  RRHH_MANAGER
  COMERCIAL
  VIEWER
}

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String
  image            String?
  provider         String    @default("credentials")
  password         String?
  phone            String?
  phoneVerifiedAt  DateTime?
  role             Role      @default(CLIENTE)
  totpSecret       String?
  totpEnabled      Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  profiles         UserProfile[]
  cliente          Cliente?

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ═══════════════════════════════════════════════════════════════
// PERMISOS
// ═══════════════════════════════════════════════════════════════

model PermissionProfile {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  grants      PermissionGrant[]
  users       UserProfile[]

  @@map("permission_profiles")
}

model PermissionGrant {
  id          String  @id @default(cuid())
  profileId   String
  profile     PermissionProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  operationId String

  canView     Boolean @default(false)
  canCreate   Boolean @default(false)
  canExecute  Boolean @default(false)
  canApprove  Boolean @default(false)

  @@unique([profileId, operationId])
  @@index([operationId])
  @@map("permission_grants")
}

model UserProfile {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  profileId String
  profile   PermissionProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([userId, profileId])
  @@map("user_profiles")
}

// ═══════════════════════════════════════════════════════════════
// EVENTOS
// ═══════════════════════════════════════════════════════════════

model BusinessEvent {
  id          String   @id @default(cuid())
  operationId String
  entityType  String
  entityId    String
  payload     Json?
  userId      String?
  status      String   @default("COMPLETED")
  error       String?
  createdAt   DateTime @default(now())

  @@index([operationId])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("business_events")
}

// ═══════════════════════════════════════════════════════════════
// FLOTA — MOTOS
// ═══════════════════════════════════════════════════════════════

enum EstadoMoto {
  EN_DEPOSITO
  EN_PATENTAMIENTO
  DISPONIBLE
  RESERVADA
  ALQUILADA
  EN_SERVICE
  EN_REPARACION
  INMOVILIZADA
  RECUPERACION
  BAJA_TEMP
  BAJA_DEFINITIVA
  TRANSFERIDA
}

enum TipoMoto {
  NAKED
  TOURING
  SPORT
  SCOOTER
  CUSTOM
}

enum EstadoPatentamiento {
  PENDIENTE
  EN_TRAMITE
  COMPLETADO
  RECHAZADO
}

enum EstadoSeguro {
  SIN_SEGURO
  EN_TRAMITE
  ACTIVO
  VENCIDO
  SUSPENDIDO
}

enum EstadoLegalMoto {
  LIMPIO
  INHIBIDA
  SECUESTRADA
  EN_JUICIO
}

enum TipoBaja {
  ROBO
  SINIESTRO
  VENTA
  CHATARRA
  DEVOLUCION_FABRICANTE
}

enum TipoDocumentoMoto {
  TITULO
  CEDULA_VERDE
  CEDULA_AZUL
  POLIZA_SEGURO
  VTV
  FORMULARIO_08
  FORMULARIO_12
  FORMULARIO_13
  FOTO_GENERAL
  FOTO_DANO
  INFORME_MECANICO
  OTRO
}

enum MetodoAmortizacion {
  LINEAL
}

enum FuenteKm {
  MANUAL
  GPS
  SERVICE
  INSPECCION
}

model Moto {
  id              String       @id @default(cuid())

  // ── Identificación ──
  marca           String
  modelo          String
  anio            Int
  patente         String?      @unique
  numMotor        String?      @unique
  numChasis       String?      @unique
  color           String?
  cilindrada      Int?
  tipo            TipoMoto     @default(NAKED)

  // ── Estado operativo ──
  estado          EstadoMoto   @default(EN_DEPOSITO)
  estadoAnterior  EstadoMoto?

  // ── Kilometraje ──
  km              Int          @default(0)
  kmUltimaLectura DateTime?

  // ── Patentamiento ──
  estadoPatentamiento  EstadoPatentamiento @default(PENDIENTE)
  fechaPatentamiento   DateTime?
  tramitePatente       String?

  // ── Seguro ──
  estadoSeguro      EstadoSeguro @default(SIN_SEGURO)
  aseguradora       String?
  numPoliza         String?
  fechaInicioSeguro DateTime?
  fechaFinSeguro    DateTime?

  // ── Legal ──
  estadoLegal      EstadoLegalMoto @default(LIMPIO)

  // ── Financiero / Compra ──
  precioCompra      Decimal?   @db.Decimal(12, 2)
  fechaCompra       DateTime?
  proveedorCompra   String?
  numFacturaCompra  String?
  monedaCompra      String     @default("ARS")
  cotizacionCompra  Decimal?   @db.Decimal(12, 2)

  // ── Alquiler ──
  precioAlquilerMensual  Decimal?  @db.Decimal(12, 2)

  // ── Amortización ──
  metodoAmortizacion  MetodoAmortizacion @default(LINEAL)
  vidaUtilMeses       Int        @default(60)
  valorResidual       Decimal    @default(0) @db.Decimal(12, 2)
  fechaAltaContable   DateTime?

  // ── Ubicación ──
  ubicacion        String?

  // ── Imagen ──
  imagenUrl        String?
  fotos            String[]

  // ── Catálogo Público ──
  destacada        Boolean    @default(false)

  // ── Especificaciones Técnicas ──
  potencia         String?
  tipoMotor        String?
  arranque         String?
  frenos           String?
  capacidadTanque  Decimal?   @db.Decimal(5, 2)
  peso             Decimal?   @db.Decimal(6, 2)

  // ── Notas ──
  notas            String?

  // ── Metadata ──
  creadoPor        String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  // ── Relaciones ──
  documentos       DocumentoMoto[]
  historialEstados HistorialEstadoMoto[]
  lecturasKm       LecturaKm[]
  baja             BajaMoto?
  amortizaciones   Amortizacion[]
  contratos        Contrato[]
  solicitudes      Solicitud[]
  mantenimientos   MantenimientoProgramado[] @relation("MantenimientosMoto")

  @@index([estado])
  @@index([marca, modelo])
  @@index([patente])
  @@index([tipo])
  @@index([destacada])
  @@map("motos")
}

model DocumentoMoto {
  id        String             @id @default(cuid())
  motoId    String
  moto      Moto               @relation(fields: [motoId], references: [id], onDelete: Cascade)
  tipo      TipoDocumentoMoto
  nombre    String
  url       String
  tamano    Int?
  mimeType  String?
  notas     String?
  creadoPor String?
  createdAt DateTime           @default(now())

  @@index([motoId])
  @@map("documentos_moto")
}

model HistorialEstadoMoto {
  id             String     @id @default(cuid())
  motoId         String
  moto           Moto       @relation(fields: [motoId], references: [id], onDelete: Cascade)
  estadoAnterior EstadoMoto
  estadoNuevo    EstadoMoto
  motivo         String?
  userId         String?
  createdAt      DateTime   @default(now())

  @@index([motoId])
  @@index([createdAt])
  @@map("historial_estado_moto")
}

model LecturaKm {
  id        String    @id @default(cuid())
  motoId    String
  moto      Moto      @relation(fields: [motoId], references: [id], onDelete: Cascade)
  km        Int
  fuente    FuenteKm  @default(MANUAL)
  notas     String?
  userId    String?
  createdAt DateTime  @default(now())

  @@index([motoId])
  @@index([createdAt])
  @@map("lecturas_km")
}

model BajaMoto {
  id              String   @id @default(cuid())
  motoId          String   @unique
  moto            Moto     @relation(fields: [motoId], references: [id], onDelete: Cascade)
  tipo            TipoBaja
  fecha           DateTime @default(now())
  motivo          String
  montoRecuperado Decimal? @db.Decimal(12, 2)
  numDenuncia     String?
  userId          String?
  createdAt       DateTime @default(now())

  @@map("bajas_moto")
}

model Amortizacion {
  id          String   @id @default(cuid())
  motoId      String
  moto        Moto     @relation(fields: [motoId], references: [id], onDelete: Cascade)
  periodo     String
  monto       Decimal  @db.Decimal(12, 2)
  acumulado   Decimal  @db.Decimal(12, 2)
  valorLibros Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now())

  @@unique([motoId, periodo])
  @@index([motoId])
  @@index([periodo])
  @@map("amortizaciones")
}

// ═══════════════════════════════════════════════════════════════
// CONFIGURACION EMPRESA
// ═══════════════════════════════════════════════════════════════

enum CondicionIva {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTISTA
  EXENTO
  CONSUMIDOR_FINAL
}

model ConfiguracionEmpresa {
  id                String       @id @default(cuid())
  razonSocial       String       @default("MotoLibre S.A.")
  cuit              String       @default("30-71617222-4")
  direccion         String       @default("Tucumán 141, Piso 4, Of. I, CABA")
  telefono          String       @default("")
  email             String       @default("")
  condicionIva      CondicionIva @default(RESPONSABLE_INSCRIPTO)
  inicioActividades DateTime?
  logo              String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@map("configuracion_empresa")
}

// ═══════════════════════════════════════════════════════════════
// CLIENTES
// ═══════════════════════════════════════════════════════════════

enum EstadoCliente {
  PENDIENTE
  EN_REVISION
  APROBADO
  RECHAZADO
  SUSPENDIDO
  BAJA
}

enum TipoDocumentoCliente {
  DNI_FRENTE
  DNI_DORSO
  LICENCIA_CONDUCIR_FRENTE
  LICENCIA_CONDUCIR_DORSO
  COMPROBANTE_DOMICILIO
  RECIBO_SUELDO
  CONSTANCIA_MONOTRIBUTO
  SELFIE
  CONTRATO_FIRMADO
  OTRO
}

enum TipoLicencia {
  A1
  A2
  A3
}

model Cliente {
  id              String         @id @default(cuid())

  // ── Datos personales ──
  nombre          String
  apellido        String
  email           String         @unique
  telefono        String
  telefonoAlt     String?
  dni             String         @unique
  fechaNacimiento DateTime?
  genero          String?
  nacionalidad    String?        @default("Argentina")

  // ── Licencia de conducir ──
  tipoLicencia    TipoLicencia?
  numLicencia     String?
  fechaVencLicencia DateTime?

  // ── Dirección ──
  calle           String?
  numero          String?
  piso            String?
  depto           String?
  localidad       String?
  provincia       String?        @default("CABA")
  codigoPostal    String?

  // ── Fiscal ──
  cuit            String?        @unique
  condicionIva    CondicionIva   @default(CONSUMIDOR_FINAL)

  // ── Trabajo / Delivery ──
  plataformas     String?
  experienciaMeses Int?

  // ── Estado y aprobación ──
  estado          EstadoCliente  @default(PENDIENTE)
  motivoRechazo   String?
  fechaAprobacion DateTime?
  aprobadoPor     String?

  // ── Scoring ──
  score           Int?           @default(0)

  // ── Referencia ──
  comoNosConocio  String?
  referidoPor     String?

  // ── Imagen ──
  fotoUrl         String?

  // ── Notas internas ──
  notas           String?

  // ── Relación con User (si tiene cuenta) ──
  userId          String?        @unique
  user            User?          @relation(fields: [userId], references: [id])

  // ── Metadata ──
  creadoPor       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // ── Relaciones ──
  documentos      DocumentoCliente[]
  puntajes        PuntajeRider[]
  contratos       Contrato[]
  solicitudes     Solicitud[]
  mantenimientos  MantenimientoProgramado[]

  @@index([estado])
  @@index([email])
  @@index([dni])
  @@index([apellido, nombre])
  @@map("clientes")
}

model DocumentoCliente {
  id                String               @id @default(cuid())
  clienteId         String
  cliente           Cliente              @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  tipo              TipoDocumentoCliente
  nombre            String
  url               String
  tamano            Int?
  mimeType          String?
  verificado        Boolean              @default(false)
  verificadoPor     String?
  fechaVerificacion DateTime?
  notas             String?
  createdAt         DateTime             @default(now())

  @@index([clienteId])
  @@map("documentos_cliente")
}

model PuntajeRider {
  id        String   @id @default(cuid())
  clienteId String
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  categoria String
  valor     Int
  motivo    String?
  userId    String?
  createdAt DateTime @default(now())

  @@index([clienteId])
  @@map("puntajes_rider")
}

// ═══════════════════════════════════════════════════════════════
// CONTRATOS
// ═══════════════════════════════════════════════════════════════

enum EstadoContrato {
  BORRADOR
  ACTIVO
  FINALIZADO
  CANCELADO
  FINALIZADO_COMPRA
  VENCIDO
}

enum FrecuenciaPago {
  SEMANAL
  QUINCENAL
  MENSUAL
}

enum EstadoCuota {
  PENDIENTE
  PAGADA
  PARCIAL
  VENCIDA
  CANCELADA
}

model Contrato {
  id              String          @id @default(cuid())

  // ── Partes ──
  clienteId       String
  cliente         Cliente         @relation(fields: [clienteId], references: [id])
  motoId          String
  moto            Moto            @relation(fields: [motoId], references: [id])

  // ── Estado ──
  estado          EstadoContrato  @default(BORRADOR)

  // ── Fechas ──
  fechaInicio      DateTime?
  fechaFin         DateTime?
  fechaFinReal     DateTime?
  fechaActivacion  DateTime?
  fechaCancelacion DateTime?

  // ── Pago ──
  frecuenciaPago   FrecuenciaPago  @default(MENSUAL)
  montoPeriodo     Decimal         @db.Decimal(12, 2)
  deposito         Decimal         @default(0) @db.Decimal(12, 2)
  depositoDevuelto Boolean         @default(false)
  duracionMeses    Int             @default(12)

  // ── Opción a compra ──
  tieneOpcionCompra Boolean        @default(false)
  precioCompra      Decimal?       @db.Decimal(12, 2)
  fechaEjercicio    DateTime?

  // ── Renovación ──
  renovacionAuto     Boolean        @default(false)
  contratoAnteriorId String?
  contratoAnterior   Contrato?      @relation("Renovacion", fields: [contratoAnteriorId], references: [id])
  contratosRenovados Contrato[]     @relation("Renovacion")

  // ── Cancelación ──
  motivoCancelacion String?
  penalidad         Decimal?        @db.Decimal(12, 2)

  // ── Notas ──
  notas             String?

  // ── Metadata ──
  creadoPor         String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // ── Lease-to-own ──
  esLeaseToOwn      Boolean         @default(false)
  transferidaAt     DateTime?

  // ── Relaciones ──
  cuotas            Cuota[]
  solicitud         Solicitud?
  mantenimientos    MantenimientoProgramado[]

  @@index([clienteId])
  @@index([motoId])
  @@index([estado])
  @@index([fechaInicio])
  @@map("contratos")
}

model Cuota {
  id               String      @id @default(cuid())
  contratoId       String
  contrato         Contrato    @relation(fields: [contratoId], references: [id], onDelete: Cascade)

  numero           Int
  monto            Decimal     @db.Decimal(12, 2)
  fechaVencimiento DateTime

  estado           EstadoCuota @default(PENDIENTE)
  fechaPago        DateTime?
  montoPagado      Decimal?    @db.Decimal(12, 2)

  notas            String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@unique([contratoId, numero])
  @@index([contratoId])
  @@index([estado])
  @@index([fechaVencimiento])
  @@map("cuotas")
}

// ═══════════════════════════════════════════════════════════════
// PRICING — TARIFAS DE ALQUILER
// ═══════════════════════════════════════════════════════════════

enum CondicionMoto {
  NUEVA
  USADA
}

enum PlanDuracion {
  MESES_3
  MESES_6
  MESES_9
  MESES_12
  MESES_24
}

model TarifaAlquiler {
  id              String          @id @default(cuid())

  // ── Dimensiones ──
  marca           String
  modelo          String
  condicion       CondicionMoto
  plan            PlanDuracion
  frecuencia      FrecuenciaPago

  // ── Precio ──
  precio          Decimal         @db.Decimal(12, 2)

  // ── Validez ──
  activo          Boolean         @default(true)
  vigenciaDesde   DateTime        @default(now())
  vigenciaHasta   DateTime?

  // ── Metadata ──
  creadoPor       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([marca, modelo, condicion, plan, frecuencia, vigenciaDesde])
  @@index([marca, modelo])
  @@index([condicion, plan, frecuencia])
  @@index([activo])
  @@map("tarifas_alquiler")
}

// ═══════════════════════════════════════════════════════════════
// SOLICITUDES DE ALQUILER
// ═══════════════════════════════════════════════════════════════

enum EstadoSolicitud {
  PAGO_PENDIENTE
  PAGADA
  EN_EVALUACION
  APROBADA
  EN_ESPERA
  ASIGNADA
  ENTREGADA
  RECHAZADA
  CANCELADA
  REEMBOLSADA
}

model Solicitud {
  id                String           @id @default(cuid())

  // ── Cliente ──
  clienteId         String
  cliente           Cliente          @relation(fields: [clienteId], references: [id])

  // ── Qué quiere ──
  marcaDeseada      String
  modeloDeseado     String
  condicionDeseada  CondicionMoto
  plan              PlanDuracion

  // ── Plan público (F4.1) ──
  planAlquilerId    String?
  planAlquiler      PlanAlquiler?    @relation(fields: [planAlquilerId], references: [id])

  // ── Precios ──
  precioSemanal     Decimal          @db.Decimal(12, 2)
  precioMensual     Decimal?         @db.Decimal(12, 2)
  montoPrimerMes    Decimal          @db.Decimal(12, 2)

  // ── Estado ──
  estado            EstadoSolicitud  @default(PAGO_PENDIENTE)

  // ── Pago adelantado ──
  mpPaymentId       String?
  mpPreferenceId    String?
  fechaPago         DateTime?

  // ── Evaluación ──
  evaluadoPor       String?
  fechaEvaluacion   DateTime?
  motivoRechazo     String?

  // ── Asignación ──
  motoAsignadaId    String?
  moto              Moto?            @relation(fields: [motoAsignadaId], references: [id])
  fechaAsignacion   DateTime?

  // ── Entrega ──
  fechaEntrega      DateTime?

  // ── Contrato generado ──
  contratoId        String?          @unique
  contrato          Contrato?        @relation(fields: [contratoId], references: [id])

  // ── Lista de espera ──
  prioridadEspera   Int?

  // ── Notas ──
  notas             String?

  // ── Metadata ──
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([clienteId])
  @@index([estado])
  @@index([marcaDeseada, modeloDeseado])
  @@index([prioridadEspera])
  @@map("solicitudes")
}

// ═══════════════════════════════════════════════════════════════
// MANTENIMIENTOS PROGRAMADOS
// ═══════════════════════════════════════════════════════════════

enum EstadoMantenimiento {
  PROGRAMADO
  NOTIFICADO
  COMPLETADO
  NO_ASISTIO
  CANCELADO
  REPROGRAMADO
}

model MantenimientoProgramado {
  id              String               @id @default(cuid())

  // ── Relaciones ──
  contratoId      String
  contrato        Contrato             @relation(fields: [contratoId], references: [id])
  motoId          String
  moto            Moto                 @relation("MantenimientosMoto", fields: [motoId], references: [id])
  clienteId       String
  cliente         Cliente              @relation(fields: [clienteId], references: [id])

  // ── Programación ──
  numero          Int
  fechaProgramada DateTime
  fechaRealizada  DateTime?

  // ── Estado ──
  estado          EstadoMantenimiento  @default(PROGRAMADO)
  notas           String?
  notasOperador   String?

  // ── Si se reprogramó ──
  fechaOriginal        DateTime?
  motivoReprogramacion String?

  // ── Metadata ──
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@unique([contratoId, numero])
  @@index([contratoId])
  @@index([motoId])
  @@index([clienteId])
  @@index([fechaProgramada])
  @@index([estado])
  @@map("mantenimientos_programados")
}

// ═══════════════════════════════════════════════════════════════
// PAGOS MERCADOPAGO
// ═══════════════════════════════════════════════════════════════

enum EstadoPagoMP {
  PENDIENTE
  APROBADO
  RECHAZADO
  REEMBOLSADO
  EN_PROCESO
  CANCELADO
}

enum TipoPagoMP {
  PRIMER_MES
  CUOTA_RECURRENTE
  CUOTA_INDIVIDUAL
  REFUND
}

model PagoMercadoPago {
  id                String        @id @default(cuid())

  tipo              TipoPagoMP

  solicitudId       String?
  contratoId        String?
  cuotaId           String?

  mpPaymentId       String?       @unique
  mpPreferenceId    String?
  mpPreapprovalId   String?
  mpStatus          String?
  mpStatusDetail    String?
  mpPaymentMethodId String?
  mpPaymentTypeId   String?

  monto             Decimal       @db.Decimal(12, 2)
  montoNeto         Decimal?      @db.Decimal(12, 2)
  comisionMP        Decimal?      @db.Decimal(12, 2)

  estado            EstadoPagoMP  @default(PENDIENTE)

  fechaPago         DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([solicitudId])
  @@index([contratoId])
  @@index([cuotaId])
  @@index([mpPaymentId])
  @@index([estado])
  @@map("pagos_mercadopago")
}

model SuscripcionMP {
  id                String    @id @default(cuid())
  contratoId        String    @unique
  clienteEmail      String
  mpPreapprovalId   String    @unique
  mpStatus          String
  frecuencia        String
  monto             Decimal   @db.Decimal(12, 2)
  fechaInicio       DateTime
  fechaFin          DateTime
  initPoint         String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([contratoId])
  @@index([mpPreapprovalId])
  @@map("suscripciones_mp")
}

// ═══════════════════════════════════════════════════════════════
// FACTURAS
// ═══════════════════════════════════════════════════════════════

enum TipoFactura {
  A    // RI → RI (discrimina IVA)
  B    // RI → CF/Mono/Exento (IVA incluido)
  C    // Monotributista → cualquiera
}

enum EstadoFactura {
  GENERADA      // PDF generado, pendiente de envío
  ENVIADA       // Email enviado al cliente
  ANULADA       // Nota de crédito emitida
}

model Factura {
  id              String         @id @default(cuid())

  // ── Numeración ──
  tipo            TipoFactura
  puntoVenta      String         // "0001"
  numero          Int            // secuencial por tipo+puntoVenta
  numeroCompleto  String         @unique  // "A-0001-00000001"

  // ── Emisor ──
  emisorRazonSocial   String
  emisorCuit          String
  emisorCondicionIva  String
  emisorDomicilio     String

  // ── Receptor ──
  receptorNombre      String
  receptorCuit        String?
  receptorCondicionIva String
  receptorDomicilio   String?

  // ── Montos ──
  montoNeto       Decimal        @db.Decimal(12, 2)
  montoIva        Decimal        @db.Decimal(12, 2)
  montoTotal      Decimal        @db.Decimal(12, 2)

  // ── CAE ──
  cae             String?
  caeVencimiento  DateTime?

  // ── Concepto ──
  concepto        String
  periodoDesde    DateTime?
  periodoHasta    DateTime?

  // ── Relaciones ──
  clienteId       String
  contratoId      String?
  pagoMPId        String?
  cuotaId         String?

  // ── Estado ──
  estado          EstadoFactura  @default(GENERADA)
  fechaEmision    DateTime       @default(now())
  emailEnviado    Boolean        @default(false)
  emailEnviadoAt  DateTime?

  // ── PDF ──
  pdfUrl          String?

  // ── Metadata ──
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@unique([tipo, puntoVenta, numero])
  @@index([clienteId])
  @@index([contratoId])
  @@index([estado])
  @@index([fechaEmision])
  @@map("facturas")
}

// ═══════════════════════════════════════════════════════════════
// CONTABILIDAD — PLAN DE CUENTAS
// ═══════════════════════════════════════════════════════════════

enum TipoCuenta {
  ACTIVO
  PASIVO
  PATRIMONIO
  INGRESO
  EGRESO
}

model CuentaContable {
  id                String          @id @default(cuid())
  codigo            String          @unique    // "1.1.01.001"
  nombre            String                     // "Caja en Pesos"
  tipo              TipoCuenta                 // ACTIVO, PASIVO, etc.
  nivel             Int                        // 1=rubro, 2=subrubro, 3=cuenta, 4=subcuenta
  padreId           String?
  padre             CuentaContable? @relation("CuentaHijos", fields: [padreId], references: [id])
  hijos             CuentaContable[] @relation("CuentaHijos")
  aceptaMovimientos Boolean         @default(false) // true = se pueden cargar asientos
  activa            Boolean         @default(true)
  descripcion       String?

  // ── Relaciones ──
  lineasAsiento     LineaAsiento[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([codigo])
  @@index([tipo])
  @@index([padreId])
  @@index([nivel])
  @@map("cuentas_contables")
}

// ═══════════════════════════════════════════════════════════════
// CONTABILIDAD — ASIENTOS
// ═══════════════════════════════════════════════════════════════

enum TipoAsiento {
  MANUAL            // Creado por el usuario
  VENTA             // Cobro de alquiler
  COMPRA            // Compra de moto u otro activo
  DEPRECIACION      // Amortización mensual
  GASTO             // Gasto operativo
  AJUSTE            // Ajuste contable
  CIERRE            // Asiento de cierre de ejercicio
}

model AsientoContable {
  id              String         @id @default(cuid())
  numero          Int            @unique @default(autoincrement())
  fecha           DateTime
  tipo            TipoAsiento
  descripcion     String
  totalDebe       Decimal        @db.Decimal(14, 2) @default(0)
  totalHaber      Decimal        @db.Decimal(14, 2) @default(0)
  cerrado         Boolean        @default(false) // una vez verificado, no se edita

  // ── Origen ──
  origenTipo      String?        // "Contrato", "PagoMercadoPago", "Factura", etc.
  origenId        String?        // ID de la entidad que generó el asiento
  eventoId        String?        // BusinessEvent que lo disparó

  // ── Período ──
  periodoId       String?
  periodo         PeriodoContable? @relation(fields: [periodoId], references: [id])

  // ── Líneas ──
  lineas          LineaAsiento[]

  // ── Metadata ──
  creadoPor       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([fecha])
  @@index([tipo])
  @@index([periodoId])
  @@index([origenTipo, origenId])
  @@map("asientos_contables")
}

model LineaAsiento {
  id              String          @id @default(cuid())

  asientoId       String
  asiento         AsientoContable @relation(fields: [asientoId], references: [id], onDelete: Cascade)

  cuentaId        String
  cuenta          CuentaContable  @relation(fields: [cuentaId], references: [id])

  debe            Decimal         @db.Decimal(14, 2) @default(0)
  haber           Decimal         @db.Decimal(14, 2) @default(0)
  descripcion     String?

  createdAt       DateTime        @default(now())

  @@index([asientoId])
  @@index([cuentaId])
  @@map("lineas_asiento")
}

// ═══════════════════════════════════════════════════════════════
// CONTABILIDAD — PERÍODOS
// ═══════════════════════════════════════════════════════════════

model PeriodoContable {
  id              String    @id @default(cuid())
  anio            Int
  mes             Int       // 1-12
  nombre          String    // "Enero 2026", "Febrero 2026"
  cerrado         Boolean   @default(false)
  fechaCierre     DateTime?
  cerradoPor      String?

  asientos        AsientoContable[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([anio, mes])
  @@index([cerrado])
  @@map("periodos_contables")
}

// ═══════════════════════════════════════════════════════════════
// GASTOS
// ═══════════════════════════════════════════════════════════════

enum CategoriaGasto {
  COMBUSTIBLE
  SEGUROS
  MANTENIMIENTO
  REPUESTOS
  ADMINISTRATIVO
  ALQUILER_LOCAL
  SERVICIOS
  IMPUESTOS
  BANCARIOS
  PUBLICIDAD
  SUELDOS
  LEGAL
  OTROS
}

enum EstadoGasto {
  PENDIENTE
  APROBADO
  RECHAZADO
  ANULADO
}

model Gasto {
  id              String         @id @default(cuid())
  fecha           DateTime
  monto           Decimal        @db.Decimal(12, 2)
  categoria       CategoriaGasto
  descripcion     String
  comprobante     String?
  estado          EstadoGasto    @default(PENDIENTE)

  medioPago       String         @default("CAJA")

  responsableId   String?
  aprobadoPor     String?
  aprobadoAt      DateTime?

  asientoId       String?

  motoId          String?
  contratoId      String?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([categoria])
  @@index([estado])
  @@index([fecha])
  @@index([motoId])
  @@map("gastos")
}

// ═══════════════════════════════════════════════════════════════
// PRESUPUESTOS MENSUALES
// ═══════════════════════════════════════════════════════════════

model PresupuestoMensual {
  id                 String         @id @default(cuid())
  anio               Int
  mes                Int
  categoria          CategoriaGasto
  montoPresupuestado Decimal        @db.Decimal(12, 2)
  montoEjecutado     Decimal        @db.Decimal(12, 2) @default(0)
  notas              String?

  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@unique([anio, mes, categoria])
  @@index([anio, mes])
  @@map("presupuestos_mensuales")
}

// ═══════════════════════════════════════════════════════════════
// NOTAS DE CRÉDITO
// ═══════════════════════════════════════════════════════════════

enum TipoNotaCredito {
  ANULACION
  DESCUENTO
  DEVOLUCION
}

enum EstadoNotaCredito {
  GENERADA
  ENVIADA
  ANULADA
}

model NotaCredito {
  id              String            @id @default(cuid())

  tipo            TipoNotaCredito
  tipoComprobante String            @default("NC")
  puntoVenta      String
  numero          Int
  numeroCompleto  String            @unique

  facturaId       String
  facturaNumero   String

  receptorNombre  String
  receptorCuit    String?
  receptorCondicionIva String

  montoNeto       Decimal           @db.Decimal(12, 2)
  montoIva        Decimal           @db.Decimal(12, 2)
  montoTotal      Decimal           @db.Decimal(12, 2)

  motivo          String

  estado          EstadoNotaCredito @default(GENERADA)
  fechaEmision    DateTime          @default(now())

  cae             String?
  caeVencimiento  DateTime?

  clienteId       String
  asientoId       String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([tipoComprobante, puntoVenta, numero])
  @@index([facturaId])
  @@index([clienteId])
  @@index([estado])
  @@map("notas_credito")
}

// ═══════════════════════════════════════════════════════════════
// FACTURAS DE COMPRA (PROVEEDORES)
// ═══════════════════════════════════════════════════════════════

enum TipoFacturaCompra {
  A
  B
  C
  M
}

enum EstadoFacturaCompra {
  PENDIENTE
  PAGADA
  PARCIAL
  ANULADA
}

model FacturaCompra {
  id              String              @id @default(cuid())

  proveedorNombre String
  proveedorCuit   String
  proveedorCondicionIva String
  proveedorId     String?

  tipo            TipoFacturaCompra
  puntoVenta      String
  numero          String
  numeroCompleto  String

  montoNeto       Decimal             @db.Decimal(12, 2)
  montoIva        Decimal             @db.Decimal(12, 2)
  montoTotal      Decimal             @db.Decimal(12, 2)

  fechaEmision    DateTime
  fechaVencimiento DateTime?

  cae             String?

  concepto        String
  categoria       CategoriaGasto?

  estado          EstadoFacturaCompra @default(PENDIENTE)
  montoPagado     Decimal             @db.Decimal(12, 2) @default(0)

  archivoUrl      String?

  asientoId       String?
  motoId          String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([proveedorCuit])
  @@index([proveedorId])
  @@index([estado])
  @@index([fechaEmision])
  @@index([tipo])
  @@map("facturas_compra")
}

// ═══════════════════════════════════════════════════════════════
// MANTENIMIENTOS — ÓRDENES DE TRABAJO
// ═══════════════════════════════════════════════════════════════

enum EstadoOT {
  SOLICITADA
  APROBADA
  PROGRAMADA
  EN_ESPERA_REPUESTOS
  EN_EJECUCION
  EN_REVISION
  COMPLETADA
  CANCELADA
}

enum TipoOT {
  PREVENTIVO
  CORRECTIVO
  EMERGENCIA
}

enum PrioridadOT {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

enum TipoService {
  SERVICE_5000KM
  SERVICE_10000KM
  SERVICE_15000KM
  SERVICE_20000KM
  SERVICE_GENERAL
  REPARACION
  INSPECCION
  OTRO
}

enum CategoriaTarea {
  MOTOR
  FRENOS
  SUSPENSION
  ELECTRICA
  CARROCERIA
  NEUMATICOS
  TRANSMISION
  LUBRICACION
  INSPECCION
  OTRO
}

enum ResultadoTarea {
  PENDIENTE
  OK
  REQUIERE_ATENCION
  REEMPLAZADO
  NO_APLICA
}

model OrdenTrabajo {
  id                  String        @id @default(cuid())

  // ── Identificación ──
  numero              String        @unique  // "OT-2026-00001"
  tipo                TipoOT
  prioridad           PrioridadOT   @default(MEDIA)
  tipoService         TipoService?
  estado              EstadoOT      @default(SOLICITADA)

  // ── Moto ──
  motoId              String
  kmIngreso           Int?
  kmEgreso            Int?

  // ── Cliente/Contrato ──
  contratoId          String?
  clienteId           String?

  // ── Programación ──
  fechaSolicitud      DateTime      @default(now())
  fechaAprobacion     DateTime?
  fechaProgramada     DateTime?
  fechaInicioReal     DateTime?
  fechaFinReal        DateTime?
  fechaCheckIn        DateTime?
  fechaCheckOut       DateTime?

  // ── Taller/Mecánico ──
  tallerNombre        String?
  mecanicoNombre      String?

  // ── Descripción ──
  descripcion         String
  diagnostico         String?
  observaciones       String?
  motivoCancelacion   String?

  // ── Costos ──
  costoManoObra       Decimal?      @db.Decimal(12, 2) @default(0)
  costoRepuestos      Decimal?      @db.Decimal(12, 2) @default(0)
  costoTotal          Decimal?      @db.Decimal(12, 2) @default(0)

  // ── Origen ──
  mantenimientoProgramadoId String?
  solicitadoPor       String?

  // ── Taller/Mecánico FK ──
  tallerId            String?
  mecanicoId          String?

  // ── Contabilidad ──
  asientoId           String?

  // ── Relaciones ──
  tareas              TareaOrdenTrabajo[]
  repuestos           RepuestoOrdenTrabajo[]
  fotos               FotoInspeccion[]
  historial           HistorialOT[]

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@index([estado])
  @@index([motoId])
  @@index([tipo])
  @@index([fechaProgramada])
  @@index([mantenimientoProgramadoId])
  @@map("ordenes_trabajo")
}

model TareaOrdenTrabajo {
  id                String          @id @default(cuid())
  ordenTrabajoId    String
  ordenTrabajo      OrdenTrabajo    @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  categoria         CategoriaTarea
  descripcion       String
  resultado         ResultadoTarea  @default(PENDIENTE)
  observaciones     String?
  orden             Int             @default(0)

  createdAt         DateTime        @default(now())

  @@index([ordenTrabajoId])
  @@map("tareas_orden_trabajo")
}

model RepuestoOrdenTrabajo {
  id                String          @id @default(cuid())
  ordenTrabajoId    String
  ordenTrabajo      OrdenTrabajo    @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  nombre            String
  cantidad          Int
  precioUnitario    Decimal         @db.Decimal(12, 2)
  subtotal          Decimal         @db.Decimal(12, 2)
  repuestoId        String?

  createdAt         DateTime        @default(now())

  @@index([ordenTrabajoId])
  @@map("repuestos_orden_trabajo")
}

model FotoInspeccion {
  id                String          @id @default(cuid())
  ordenTrabajoId    String
  ordenTrabajo      OrdenTrabajo    @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  url               String
  tipo              String          // "CHECK_IN", "CHECK_OUT", "DURANTE", "REPUESTO"
  descripcion       String?

  createdAt         DateTime        @default(now())

  @@index([ordenTrabajoId])
  @@map("fotos_inspeccion")
}

model HistorialOT {
  id                String          @id @default(cuid())
  ordenTrabajoId    String
  ordenTrabajo      OrdenTrabajo    @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  estadoAnterior    EstadoOT
  estadoNuevo       EstadoOT
  descripcion       String?
  userId            String?

  createdAt         DateTime        @default(now())

  @@index([ordenTrabajoId])
  @@map("historial_ot")
}

// ═══════════════════════════════════════════════════════════════
// PLANES DE MANTENIMIENTO (TEMPLATES)
// ═══════════════════════════════════════════════════════════════

model PlanMantenimiento {
  id                String          @id @default(cuid())
  nombre            String
  tipoService       TipoService
  descripcion       String?
  kmIntervalo       Int?
  diasIntervalo     Int?
  activo            Boolean         @default(true)

  tareas            TareaPlan[]
  repuestos         RepuestoTareaPlan[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@map("planes_mantenimiento")
}

model TareaPlan {
  id                String          @id @default(cuid())
  planId            String
  plan              PlanMantenimiento @relation(fields: [planId], references: [id], onDelete: Cascade)

  categoria         CategoriaTarea
  descripcion       String
  orden             Int             @default(0)

  createdAt         DateTime        @default(now())

  @@index([planId])
  @@map("tareas_plan")
}

model RepuestoTareaPlan {
  id                String          @id @default(cuid())
  planId            String
  plan              PlanMantenimiento @relation(fields: [planId], references: [id], onDelete: Cascade)

  nombre            String
  cantidad          Int
  repuestoId        String?

  createdAt         DateTime        @default(now())

  @@index([planId])
  @@map("repuestos_tarea_plan")
}

// ═══════════════════════════════════════════════════════════════
// TALLERES Y MECÁNICOS
// ═══════════════════════════════════════════════════════════════

enum TipoTaller {
  INTERNO
  EXTERNO
}

model Taller {
  id              String      @id @default(cuid())
  nombre          String
  tipo            TipoTaller
  direccion       String?
  telefono        String?
  email           String?
  contacto        String?
  especialidades  String[]
  activo          Boolean     @default(true)
  notas           String?

  mecanicos       Mecanico[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([tipo])
  @@index([activo])
  @@map("talleres")
}

model Mecanico {
  id              String      @id @default(cuid())
  nombre          String
  apellido        String
  telefono        String?
  email           String?
  especialidad    String?
  activo          Boolean     @default(true)

  tallerId        String
  taller          Taller      @relation(fields: [tallerId], references: [id])

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([tallerId])
  @@index([activo])
  @@map("mecanicos")
}

// ═══════════════════════════════════════════════════════════════
// PROVEEDORES
// ═══════════════════════════════════════════════════════════════

enum TipoProveedor {
  NACIONAL
  INTERNACIONAL
}

model Proveedor {
  id              String         @id @default(cuid())
  nombre          String
  cuit            String?
  direccion       String?
  ciudad          String?
  provincia       String?
  pais            String         @default("Argentina")
  telefono        String?
  email           String?
  contacto        String?
  tipoProveedor   TipoProveedor  @default(NACIONAL)
  condicionIva    String?
  categorias      String[]
  notas           String?
  activo          Boolean        @default(true)

  // ── Datos bancarios ──
  cbu             String?
  alias           String?
  banco           String?

  // ── Relaciones ──
  ordenesCompra   OrdenCompra[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([tipoProveedor])
  @@index([activo])
  @@map("proveedores")
}

// ═══════════════════════════════════════════════════════════════
// ÓRDENES DE COMPRA
// ═══════════════════════════════════════════════════════════════

enum EstadoOrdenCompra {
  BORRADOR
  ENVIADA
  CONFIRMADA
  RECIBIDA
  CANCELADA
}

model OrdenCompra {
  id              String             @id @default(cuid())
  numero          String             @unique

  // ── Proveedor ──
  proveedorId     String
  proveedor       Proveedor          @relation(fields: [proveedorId], references: [id])

  // ── Estado ──
  estado          EstadoOrdenCompra  @default(BORRADOR)

  // ── Fechas ──
  fechaEmision    DateTime           @default(now())
  fechaEntregaEstimada DateTime?
  fechaRecepcion  DateTime?

  // ── Montos ──
  montoSubtotal   Decimal            @db.Decimal(12, 2) @default(0)
  montoIva        Decimal            @db.Decimal(12, 2) @default(0)
  montoTotal      Decimal            @db.Decimal(12, 2) @default(0)
  moneda          String             @default("ARS")

  // ── Metadata ──
  observaciones   String?
  motivoCancelacion String?
  aprobadoPor     String?
  creadoPor       String?

  // ── Items ──
  items           ItemOrdenCompra[]

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([proveedorId])
  @@index([estado])
  @@index([fechaEmision])
  @@map("ordenes_compra")
}

model ItemOrdenCompra {
  id              String        @id @default(cuid())
  ordenCompraId   String
  ordenCompra     OrdenCompra   @relation(fields: [ordenCompraId], references: [id], onDelete: Cascade)

  // ── Producto ──
  descripcion     String
  codigo          String?
  repuestoId      String?

  // ── Cantidades ──
  cantidad        Int
  cantidadRecibida Int          @default(0)

  // ── Precios ──
  precioUnitario  Decimal       @db.Decimal(12, 2)
  subtotal        Decimal       @db.Decimal(12, 2)

  createdAt       DateTime      @default(now())

  @@index([ordenCompraId])
  @@map("items_orden_compra")
}

// ═══════════════════════════════════════════════════════════════
// INVENTARIO DE REPUESTOS
// ═══════════════════════════════════════════════════════════════

enum CategoriaRepuesto {
  MOTOR
  FRENOS
  SUSPENSION
  ELECTRICA
  TRANSMISION
  CARROCERIA
  NEUMATICOS
  LUBRICANTES
  FILTROS
  TORNILLERIA
  ACCESORIOS
  OTRO
}

enum TipoMovimientoStock {
  INGRESO
  EGRESO
  AJUSTE_POSITIVO
  AJUSTE_NEGATIVO
  TRANSFERENCIA
  DEVOLUCION
}

model Repuesto {
  id                String            @id @default(cuid())

  // ── Identificación ──
  codigo            String            @unique
  nombre            String
  descripcion       String?
  categoria         CategoriaRepuesto
  marca             String?
  modeloCompatible  String[]

  // ── Stock ──
  stock             Int               @default(0)
  stockMinimo       Int               @default(5)
  stockMaximo       Int?
  unidad            String            @default("unidad")

  // ── Precios ──
  precioCompra      Decimal           @db.Decimal(12, 2) @default(0)
  precioVenta       Decimal?          @db.Decimal(12, 2)
  moneda            String            @default("ARS")

  // ── Importación ──
  precioFOB         Decimal?          @db.Decimal(12, 2)
  costoNacionalizado Decimal?         @db.Decimal(12, 2)

  // ── Proveedor principal ──
  proveedorId       String?
  proveedorCodigo   String?

  // ── Ubicación ──
  ubicacionId       String?
  ubicacion         UbicacionDeposito? @relation(fields: [ubicacionId], references: [id])

  // ── Estado ──
  activo            Boolean           @default(true)

  // ── Relaciones ──
  movimientos       MovimientoStock[]
  historialCostos   HistorialCostoRepuesto[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([codigo])
  @@index([categoria])
  @@index([stock])
  @@index([proveedorId])
  @@index([activo])
  @@map("repuestos")
}

model MovimientoStock {
  id              String              @id @default(cuid())

  repuestoId      String
  repuesto        Repuesto            @relation(fields: [repuestoId], references: [id])

  tipo            TipoMovimientoStock
  cantidad        Int
  stockAnterior   Int
  stockPosterior  Int

  // ── Referencia ──
  referenciaTipo  String?
  referenciaId    String?

  // ── Detalle ──
  descripcion     String?
  costoUnitario   Decimal?            @db.Decimal(12, 2)
  userId          String?

  createdAt       DateTime            @default(now())

  @@index([repuestoId])
  @@index([tipo])
  @@index([createdAt])
  @@map("movimientos_stock")
}

model UbicacionDeposito {
  id              String      @id @default(cuid())
  codigo          String      @unique
  nombre          String
  sector          String?
  nivel           String?
  descripcion     String?
  activa          Boolean     @default(true)

  repuestos       Repuesto[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("ubicaciones_deposito")
}

model HistorialCostoRepuesto {
  id              String      @id @default(cuid())
  repuestoId      String
  repuesto        Repuesto    @relation(fields: [repuestoId], references: [id])

  precioAnterior  Decimal     @db.Decimal(12, 2)
  precioNuevo     Decimal     @db.Decimal(12, 2)
  motivo          String?

  createdAt       DateTime    @default(now())

  @@index([repuestoId])
  @@map("historial_costo_repuesto")
}

// ═══════════════════════════════════════════════════════════════
// IMPORTACIONES
// ═══════════════════════════════════════════════════════════════

enum EstadoEmbarque {
  BORRADOR
  EN_TRANSITO
  EN_PUERTO
  EN_ADUANA
  DESPACHADO_PARCIAL
  DESPACHADO
  COSTOS_FINALIZADOS
  EN_RECEPCION
  ALMACENADO
  CANCELADO
}

model EmbarqueImportacion {
  id                    String          @id @default(cuid())
  numero                String          @unique
  estado                EstadoEmbarque  @default(BORRADOR)

  proveedorId           String
  proveedorNombre       String

  puertoOrigen          String?
  puertoDestino         String          @default("Buenos Aires")
  naviera               String?
  numeroContenedor      String?
  numeroBL              String?
  tipoTransporte        String          @default("MARITIMO")

  fechaEmbarque         DateTime?
  fechaEstimadaArribo   DateTime?
  fechaArriboPuerto     DateTime?
  fechaIngresoAduana    DateTime?
  fechaDespacho         DateTime?
  fechaRecepcion        DateTime?

  monedaFOB             String          @default("USD")
  totalFOB              Decimal         @db.Decimal(14, 2) @default(0)
  tipoCambio            Decimal?        @db.Decimal(10, 4)

  costoFlete            Decimal?        @db.Decimal(14, 2) @default(0)
  costoSeguro           Decimal?        @db.Decimal(14, 2) @default(0)
  totalCIF              Decimal?        @db.Decimal(14, 2) @default(0)

  derechosImportacion   Decimal?        @db.Decimal(14, 2) @default(0)
  tasaEstadistica       Decimal?        @db.Decimal(14, 2) @default(0)
  ivaImportacion        Decimal?        @db.Decimal(14, 2) @default(0)
  ivaAdicional          Decimal?        @db.Decimal(14, 2) @default(0)
  ingresosBrutos        Decimal?        @db.Decimal(14, 2) @default(0)
  gastosDespacho        Decimal?        @db.Decimal(14, 2) @default(0)

  totalNacionalizado    Decimal?        @db.Decimal(14, 2) @default(0)

  observaciones         String?
  creadoPor             String?

  items                 ItemEmbarque[]
  despachos             DespachoAduanero[]
  costosAsignados       AsignacionCostoImportacion[]

  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([estado])
  @@index([proveedorId])
  @@index([fechaEmbarque])
  @@map("embarques_importacion")
}

model ItemEmbarque {
  id                      String                @id @default(cuid())
  embarqueId              String
  embarque                EmbarqueImportacion   @relation(fields: [embarqueId], references: [id], onDelete: Cascade)

  descripcion             String
  codigoProveedor         String?
  repuestoId              String?
  esMoto                  Boolean               @default(false)

  cantidad                Int
  cantidadRecibida        Int                   @default(0)

  precioFOBUnitario       Decimal               @db.Decimal(12, 2)
  subtotalFOB             Decimal               @db.Decimal(14, 2)

  costoNacionalizadoUnit  Decimal?              @db.Decimal(12, 2)
  costoNacionalizadoTotal Decimal?              @db.Decimal(14, 2)

  posicionArancelaria     String?
  alicuotaDerechos        Decimal?              @db.Decimal(5, 2)

  createdAt               DateTime              @default(now())

  @@index([embarqueId])
  @@map("items_embarque")
}

model DespachoAduanero {
  id                  String                @id @default(cuid())
  embarqueId          String
  embarque            EmbarqueImportacion   @relation(fields: [embarqueId], references: [id], onDelete: Cascade)

  numeroDespacho      String?
  fechaDespacho       DateTime
  despachante         String?

  baseImponible       Decimal               @db.Decimal(14, 2)
  derechosImportacion Decimal               @db.Decimal(14, 2)
  tasaEstadistica     Decimal               @db.Decimal(14, 2)
  ivaImportacion      Decimal               @db.Decimal(14, 2)
  ivaAdicional        Decimal               @db.Decimal(14, 2)
  ingresosBrutos      Decimal               @db.Decimal(14, 2) @default(0)
  gastosVarios        Decimal               @db.Decimal(14, 2) @default(0)
  totalDespacho       Decimal               @db.Decimal(14, 2)

  observaciones       String?

  createdAt           DateTime              @default(now())

  @@index([embarqueId])
  @@map("despachos_aduaneros")
}

model AsignacionCostoImportacion {
  id                  String                @id @default(cuid())
  embarqueId          String
  embarque            EmbarqueImportacion   @relation(fields: [embarqueId], references: [id], onDelete: Cascade)

  itemEmbarqueId      String
  porcentajeFOB       Decimal               @db.Decimal(8, 4)
  costoAsignado       Decimal               @db.Decimal(14, 2)

  createdAt           DateTime              @default(now())

  @@index([embarqueId])
  @@index([itemEmbarqueId])
  @@map("asignaciones_costo_importacion")
}

model PortalProveedorToken {
  id                  String                @id @default(cuid())
  token               String                @unique @default(cuid())
  embarqueId          String
  proveedorId         String
  activo              Boolean               @default(true)
  expiraAt            DateTime

  createdAt           DateTime              @default(now())

  @@index([token])
  @@index([embarqueId])
  @@map("portal_proveedor_tokens")
}

// ═══════════════════════════════════════════════════════════════
// PRICING DE ALQUILER (F4.1)
// ═══════════════════════════════════════════════════════════════

model PlanAlquiler {
  id                  String                 @id @default(cuid())
  nombre              String
  codigo              String                 @unique
  descripcion         String?

  frecuencia          String                 // "SEMANAL", "MENSUAL"
  duracionMeses       Int?
  cuotasTotal         Int?
  descuentoPorcentaje Decimal?               @db.Decimal(5, 2)
  incluyeTransferencia Boolean              @default(false)

  activo              Boolean                @default(true)
  orden               Int                    @default(0)

  precios             PrecioModeloAlquiler[]
  solicitudes         Solicitud[]

  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  @@index([activo])
  @@map("planes_alquiler")
}

model PrecioModeloAlquiler {
  id              String       @id @default(cuid())

  planId          String
  plan            PlanAlquiler @relation(fields: [planId], references: [id], onDelete: Cascade)

  modeloMoto      String
  condicion       String       @default("USADA")

  precioBase      Decimal      @db.Decimal(12, 2)
  precioFinal     Decimal      @db.Decimal(12, 2)
  moneda          String       @default("ARS")

  vigenciaDesde   DateTime     @default(now())
  vigenciaHasta   DateTime?
  activo          Boolean      @default(true)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([planId, modeloMoto, condicion, activo])
  @@index([modeloMoto])
  @@index([activo])
  @@map("precios_modelo_alquiler")
}

model CostoOperativoConfig {
  id            String   @id @default(cuid())
  concepto      String   @unique
  montoMensual  Decimal  @db.Decimal(12, 2)
  descripcion   String?
  activo        Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("costos_operativos_config")
}

model HistorialPrecioAlquiler {
  id              String   @id @default(cuid())
  precioModeloId  String?
  planId          String?
  modeloMoto      String
  precioAnterior  Decimal  @db.Decimal(12, 2)
  precioNuevo     Decimal  @db.Decimal(12, 2)
  motivo          String?
  userId          String?

  createdAt       DateTime @default(now())

  @@index([modeloMoto])
  @@map("historial_precio_alquiler")
}

model TipoCambioCache {
  id        String   @id @default(cuid())
  moneda    String   @unique
  compra    Decimal  @db.Decimal(12, 4)
  venta     Decimal  @db.Decimal(12, 4)
  fecha     DateTime
  fuente    String   @default("dolarapi.com")

  updatedAt DateTime @updatedAt

  @@map("tipo_cambio_cache")
}

// ═══════════════════════════════════════════════════════════════
// PRICING DE REPUESTOS (F4.2)
// ═══════════════════════════════════════════════════════════════

enum TipoListaPrecio {
  RETAIL
  MAYORISTA
  TALLER
  PROMO
}

model ListaPrecio {
  id            String          @id @default(cuid())
  nombre        String
  tipo          TipoListaPrecio
  descripcion   String?
  activa        Boolean         @default(true)
  vigenciaDesde DateTime        @default(now())
  vigenciaHasta DateTime?
  prioridad     Int             @default(0)

  items         ItemListaPrecio[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([tipo])
  @@index([activa])
  @@map("listas_precio")
}

model ItemListaPrecio {
  id             String      @id @default(cuid())
  listaId        String
  lista          ListaPrecio @relation(fields: [listaId], references: [id], onDelete: Cascade)
  repuestoId     String
  precioUnitario Decimal     @db.Decimal(12, 2)

  createdAt      DateTime    @default(now())

  @@unique([listaId, repuestoId])
  @@index([repuestoId])
  @@map("items_lista_precio")
}

model ReglaMarkup {
  id          String            @id @default(cuid())
  categoria   CategoriaRepuesto @unique
  porcentaje  Decimal           @db.Decimal(5, 2)
  descripcion String?
  activa      Boolean           @default(true)

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@map("reglas_markup")
}

model GrupoCliente {
  id          String                @id @default(cuid())
  nombre      String
  descripcion String?
  descuento   Decimal               @db.Decimal(5, 2)
  activo      Boolean               @default(true)

  miembros    MiembroGrupoCliente[]

  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@map("grupos_cliente")
}

model MiembroGrupoCliente {
  id        String       @id @default(cuid())
  grupoId   String
  grupo     GrupoCliente @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  clienteId String

  createdAt DateTime     @default(now())

  @@unique([grupoId, clienteId])
  @@index([clienteId])
  @@map("miembros_grupo_cliente")
}

model LoteCambioPrecio {
  id                 String   @id @default(cuid())
  nombre             String
  tipo               String   // "PORCENTAJE", "MONTO_FIJO"
  valor              Decimal  @db.Decimal(12, 2)
  categorias         String[]
  proveedorId        String?
  estado             String   @default("PENDIENTE")
  fechaAplicacion    DateTime?
  fechaReversion     DateTime?
  repuestosAfectados Int      @default(0)
  userId             String?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("lotes_cambio_precio")
}

// ═══════════════════════════════════════════════════════════════
// DETECCIÓN DE ANOMALÍAS
// ═══════════════════════════════════════════════════════════════

enum TipoAnomalia {
  GASTO_INUSUAL
  PAGO_DUPLICADO
  FACTURA_SIN_PAGO
  MARGEN_BAJO
  STOCK_CRITICO
  DESVIO_PRESUPUESTO
  FLUJO_CAJA_NEGATIVO
  VENCIMIENTO_PROXIMO
  PATRON_SOSPECHOSO
}

enum SeveridadAnomalia {
  BAJA
  MEDIA
  ALTA
  CRITICA
}

enum EstadoAnomalia {
  NUEVA
  EN_REVISION
  RESUELTA
  DESCARTADA
}

model Anomalia {
  id                String              @id @default(cuid())

  tipo              TipoAnomalia
  severidad         SeveridadAnomalia
  estado            EstadoAnomalia      @default(NUEVA)

  // —— Entidad afectada ——
  entidadTipo       String              // "Gasto", "Pago", "Factura", "Moto", "Repuesto", "Presupuesto"
  entidadId         String              // ID de la entidad
  entidadLabel      String?             // Descripción legible: "Gasto #123 - Combustible"

  // —— Detección ——
  titulo            String              // "Gasto inusual detectado: $450.000 en Combustible"
  descripcion       String              // Explicación detallada
  valorDetectado    Decimal?            @db.Decimal(14, 2)
  valorEsperado     Decimal?            @db.Decimal(14, 2)

  // —— Resolución ——
  resueltoPor       String?
  resolucion        String?
  fechaResolucion   DateTime?

  // —— Metadata ——
  algoritmo         String
  datosExtra        String?             // JSON con datos adicionales del algoritmo

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([tipo])
  @@index([estado])
  @@index([severidad])
  @@index([entidadTipo, entidadId])
  @@index([createdAt])
  @@map("anomalias")
}

model AnalisisFinanciero {
  id                  String      @id @default(cuid())

  tipo                String      // "ANOMALIAS_BATCH", "SALUD_FINANCIERA"
  fechaEjecucion      DateTime    @default(now())
  duracionMs          Int?

  anomaliasDetectadas Int         @default(0)
  metricas            String?     // JSON con métricas del análisis

  ejecutadoPor        String?     // userId o "system"

  createdAt           DateTime    @default(now())

  @@index([tipo])
  @@map("analisis_financieros")
}
